---
title: "Stability selection for censored biomedical and bioinformatics data"
author: "Yunwei Zhang"
date: “`r paste0('Initiated on 20230927, compiled on ', format(Sys.time(), '%Y %b %d'))`”
output:
  
  html_document:
    code_folding: hide
    fig_height: 8
    fig_width: 12
    highlight: tango
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '4'
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE,message = FALSE)
#usethis::edit_r_environ()
#R_MAX_VSIZE=700Gb
```

This file is to get all results and initial figures in both real and simulated datasets. 
```{r}
.libPaths("/dskh/nobackup/yunwei/stability_selection_codes/stability_selection_library")
setwd("/dskh/nobackup/yunwei/stability_selection_codes")
library(inline)
openblas.set.num.threads <- cfunction( signature(ipt="integer"),
                                       body = "openblas_set_num_threads(*ipt);",
                                       otherdefs = c ("extern void openblas_set_num_threads(int);"),
                                       libargs = c ("/usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3"),
                                       language = "C",
                                       convention = ".C"
)
openblas.set.num.threads(1)

#install.packages("Matrix")
#library(Matrix)
library(survAUC)
library(reshape2)
library(ggplot2)
library(readxl)
library(ggpubr)
library(dplyr)
library(tidyverse)
library(mstate)
library(MASS)
library(survival)
library(MatchIt)
library(mice)
library(DT)
library(EnvStats)
library(pbmcapply)
library(FNN)

library(pec)
library(MultiAssayExperiment)
library(TCGAbiolinks)

library(survivalROC)
library(survival)
#library(CoxBoost) #archrived package
library(limma)
library(survivalsvm)
library(survminer)
library(randomForestSRC)
library(glmnet)
library(rms)
library(penalized)
library(riskRegression)
library(pROC)
library(ROCR)
library(cvTools)
library(parallel)
library(MTLR)
library(icenReg)#was trying to get data (miceData), however, there is no covariates with that interval censored data
library(mcsurvdata)
library(ExperimentHub)
library(hdnom)
library(Hmisc)
library(ggrepel)
```

```{r}
source("functions.R")
```

# simulated omics data (imported from code10.rmd)

We use the faux package with a correlation of 0.5.
```{r}
simulWeibCox <- function(N, shape, scale, beta,x)
{

  # get time t
  v <- runif(n=N)
  Tlat <- (- log(v) / ( (scale^(shape))*exp(as.matrix(x) %*% as.matrix(beta))))^(1/shape)

  # censoring times from the uniform distribution [2,10]
  C <- runif(N,0,1)
  # follow-up times and event indicators
  time <- pmin(Tlat, C)
  status <- as.numeric(Tlat <= C)
  # data set
  data.frame(id=1:N,
             time=time,
             status=status,
             x=x,
             Tlat=Tlat,
             C=C)
}

library(faux)

#test the function with a simple data:correct
n <- 100  # Number of rows
p <- 1000  # Number of columns
# Generate the dataset
set.seed(0814)
X <- rnorm_multi(n=n, mu=rep(0,p),sd=rep(1,p), r=0.5, varnames = paste0("X", 1:p, ""))
betas <- c(runif(3, -0.2,-0.1),runif(3,0.1,0.2),rep(0,p-6))
simulWeib_result=simulWeibCox(N=dim(X)[1], shape=0.5, scale=2, beta=betas, x=X)
simdata=simulWeib_result
# formula_string=paste(colnames(simdata[4:(p+3)]),collapse = "+")
# formula=as.formula(paste("Surv(time,status)~", formula_string))
# cox_model <- coxph(formula,data =simdata)
# cox_model$coefficients[1:6]
# betas[1:6]
summary(simdata$time)
summary(simdata$Tlat)
table(simdata$status)
```


```{r}
current_data2=simdata[,-which(colnames(simdata)%in%c("id", "Tlat","C"))]
dim(current_data2)
set.seed(230814)
rownum=sample(nrow(current_data2),nrow(current_data2)*0.2,replace = FALSE)
ex_validation=current_data2[rownum,]
current_data2=current_data2[-rownum,]
dim(ex_validation)#20
dim(current_data2)#80

#round(colMeans(current_data2),3)
#round(colMeans(X),3)

current_data2_new=current_data2[,!colnames(current_data2)%in% c("time","status")]
current_data2_new=apply(current_data2_new, 2, function(x) scale(x,scale = TRUE))
current_data2_new2=cbind.data.frame(current_data2_new,current_data2[,colnames(current_data2)%in% c("time","status")])
#round(colMeans(current_data2_new2),3)
current_data2=current_data2_new2

ex_validation_new=ex_validation[,!colnames(ex_validation)%in% c("time","status")]
ex_validation_new=apply(ex_validation_new, 2, function(x) scale(x,scale = TRUE))
ex_validation_new2=cbind.data.frame(ex_validation_new,ex_validation[,colnames(ex_validation)%in% c("time","status")])
#round(colMeans(ex_validation_new2),3)
ex_validation=ex_validation_new2
```

save simulated datasets 100 and results with control, without control (v2)
Run 100 repeated simulated datasets results. 
```{r eval=FALSE}
sim_fun=function(seed){
  set.seed(seed)
X <- rnorm_multi(n=n, mu=rep(0,p),sd=rep(1,p), r=0.5, varnames = paste0("X", 1:p, ""))
betas <- c(runif(3, -0.2,-0.1),runif(3,0.1,0.2),rep(0,p-6))
simulWeib_result=simulWeibCox(N=dim(X)[1], shape=0.5, scale=2, beta=betas, x=X)
simdata=simulWeib_result
current_data2=simdata[,-which(colnames(simdata)%in%c("id", "Tlat","C"))]
return(current_data2)
}

#simulated data list
sim_dt_list=list()
for(i in 1:100){
  sim_dt_list[[i]]=sim_fun(i)
}
#saveRDS(sim_dt_list,"sim_data_list0.5censoring_0906.RDS")

```


```{r eval=FALSE}
sim_dt_list=readRDS("sim_data_list0.5censoring_0906.RDS")
result100=list()
for(i in 1:100){
sim_dt=sim_dt_list[[i]]
sim_dt2=sim_dt
dim(sim_dt2)#280
set.seed(230906)
rownum=sample(nrow(sim_dt2),nrow(sim_dt2)*0.2,replace = FALSE)
ex_validation=sim_dt2[rownum,]
current_data2=sim_dt2[-rownum,]
dim(ex_validation)#56
dim(current_data2)#224
current_data2_new=current_data2[,!colnames(current_data2)%in% c("time","status")]
current_data2_new=apply(current_data2_new, 2, function(x) scale(x,scale = TRUE))
current_data2_new2=cbind.data.frame(current_data2_new,current_data2[,colnames(current_data2)%in% c("time","status")])
#round(colMeans(current_data2_new2),3)
current_data2=current_data2_new2

ex_validation_new=ex_validation[,!colnames(ex_validation)%in% c("time","status")]
ex_validation_new=apply(ex_validation_new, 2, function(x) scale(x,scale = TRUE))
ex_validation_new2=cbind.data.frame(ex_validation_new,ex_validation[,colnames(ex_validation)%in% c("time","status")])
#round(colMeans(ex_validation_new2),3)
ex_validation=ex_validation_new2

timess=seq(as.numeric(summary(current_data2$time)[2]),as.numeric(summary(current_data2$time)[5]),(as.numeric(summary(current_data2$time)[5])-as.numeric(summary(current_data2$time)[2]))/9)
result=pbmcapply::pbmclapply(1:500, stability_selection_fun1,data=current_data2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result2=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result3=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result4=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result5=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.4,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result6=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result7=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.6,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result8=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result9=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.8,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result10=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result11=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result12=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result13=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result14=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result15=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result16=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result17=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result100[[i]]=list(result,result2,result3,result4,result5,result6,result7,result8,result9,result10,result11,result12,result13,result14,result15, result16, result17)
}
save(result100,file="lasso_sim_0.5censoring_0906_100.RData")


result100=list()
for(i in 1:100){
sim_dt=sim_dt_list[[i]]
sim_dt2=sim_dt
dim(sim_dt2)#280
set.seed(230906)
rownum=sample(nrow(sim_dt2),nrow(sim_dt2)*0.2,replace = FALSE)
ex_validation=sim_dt2[rownum,]
current_data2=sim_dt2[-rownum,]
dim(ex_validation)#56
dim(current_data2)#224
current_data2_new=current_data2[,!colnames(current_data2)%in% c("time","status")]
current_data2_new=apply(current_data2_new, 2, function(x) scale(x,scale = TRUE))
current_data2_new2=cbind.data.frame(current_data2_new,current_data2[,colnames(current_data2)%in% c("time","status")])
#round(colMeans(current_data2_new2),3)
current_data2=current_data2_new2

ex_validation_new=ex_validation[,!colnames(ex_validation)%in% c("time","status")]
ex_validation_new=apply(ex_validation_new, 2, function(x) scale(x,scale = TRUE))
ex_validation_new2=cbind.data.frame(ex_validation_new,ex_validation[,colnames(ex_validation)%in% c("time","status")])
#round(colMeans(ex_validation_new2),3)
ex_validation=ex_validation_new2

timess=seq(as.numeric(summary(current_data2$time)[2]),as.numeric(summary(current_data2$time)[5]),(as.numeric(summary(current_data2$time)[5])-as.numeric(summary(current_data2$time)[2]))/9)
result=pbmcapply::pbmclapply(1:500, stability_selection_fun1,data=current_data2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result2=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result3=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result4=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result5=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.4,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result6=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result7=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.6,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result8=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result9=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.8,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result10=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result11=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result12=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result13=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result14=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result15=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result16=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result17=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result100[[i]]=list(result,result2,result3,result4,result5,result6,result7,result8,result9,result10,result11,result12,result13,result14,result15, result16, result17)
}
save(result100,file="lasso_sim_0.5censoring_0906_100v2.RData")
```


## one simulated dataset with restriction
```{r}
load("lasso_sim_0.5censoring_0906_100.RData")
length(result100)
length(result100[[1]])
#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

result_table=get_table(result100[[1]][[1]])[[1]]
result2_table=get_table(result100[[1]][[2]])[[1]]
result3_table=get_table(result100[[1]][[3]])[[1]]
result4_table=get_table(result100[[1]][[4]])[[1]]
result5_table=get_table(result100[[1]][[5]])[[1]]
result6_table=get_table(result100[[1]][[6]])[[1]]
result7_table=get_table(result100[[1]][[7]])[[1]]
result8_table=get_table(result100[[1]][[8]])[[1]]
result9_table=get_table(result100[[1]][[9]])[[1]]
result10_table=get_table(result100[[1]][[10]])[[1]]
result11_table=get_table(result100[[1]][[11]])[[1]]
result12_table=get_table(result100[[1]][[12]])[[1]]
result13_table=get_table(result100[[1]][[13]])[[1]]
result14_table=get_table(result100[[1]][[14]])[[1]]
result15_table=get_table(result100[[1]][[15]])[[1]]
result16_table=get_table(result100[[1]][[16]])[[1]]
result17_table=get_table(result100[[1]][[17]])[[1]]
#get average model performances and number of variables selected
# as.numeric(result[[1]][[1]])
# result[[1]][[3]]
# result[[1]][[4]]

other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

result=result100[[1]][[1]]
result2=result100[[1]][[2]]
result3=result100[[1]][[3]]
result4=result100[[1]][[4]]
result5=result100[[1]][[5]]
result6=result100[[1]][[6]]
result7=result100[[1]][[7]]
result8=result100[[1]][[8]]
result9=result100[[1]][[9]]
result10=result100[[1]][[10]]
result11=result100[[1]][[11]]
result12=result100[[1]][[12]]
result13=result100[[1]][[13]]
result14=result100[[1]][[14]]
result15=result100[[1]][[15]]
result16=result100[[1]][[16]]
result17=result100[[1]][[17]]

heatmap_data=data.frame(nrow=18*17,ncol=18)
heatmap_data[1:306,1]=rep(c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),each=18)
heatmap_data[1:306,2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),17)
heatmap_data[1:306,3]=c(other_table(result,current_data2),other_table(result2,current_data2),other_table(result3,current_data2),other_table(result4,current_data2),other_table(result5,current_data2),other_table(result6,current_data2),other_table(result7,current_data2),other_table(result8,current_data2),other_table(result9,current_data2),other_table(result10,current_data2),other_table(result11,current_data2),other_table(result12,current_data2),other_table(result13,current_data2),other_table(result14,current_data2),other_table(result15,current_data2),other_table(result16,current_data2),other_table(result17,current_data2))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))

#generate the dataset used to plot the heatmap, the rows are the datasets and the columns are metrics: censoring rate, cindex, number of variables selected
gg_heatmap_data=heatmap_data
gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]=gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]/max(gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"])
ggheatmap <-ggplot(gg_heatmap_data, aes(case, metric, fill= value)) + 
 geom_tile(color = "grey")+scale_fill_gradientn(limits = c(0,1),colours = c("#2166AC", "#67A9CF" ,"#D1E5F0", "#FFFFFF","#FDDBC7", "#EF8A62", "#B2182B"))+ theme(aspect.ratio = 1, text = element_text(size = 5), legend.position = "bottom") + labs(y= 'Metrics', x = "Cases", fill = 'Values')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))+
  geom_text(aes(label = round(value,3)), color = "black", size = 4)
ggheatmap

#get all seperate scatter plots
plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with distance_stat")

plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat_test","censoring_rate_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate_test,y=distance_stat_test,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate test with distance_stat test")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=censoring_rate,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("distance_stat with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=num_variables,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with num_variables")+theme_bw()+theme(aspect.ratio = 1)
gg
#ggsave("lasso_simomics_with_num_var.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=cindex_train,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with cindex_train")

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
#ggsave("lasso_simomics_with_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
#ggsave("lasso_simomics_with_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
#ggsave("lasso_simomics_with_external.pdf",gg)

#fit model using the entire data on lasso cox and add into the external performance
tr_matrix=data.matrix(current_data2[,!names(current_data2)%in% c("time","status")])
te_matrix=data.matrix(ex_validation[,!names(ex_validation)%in% c("time","status")])
tr_st=current_data2$time
tr_y=current_data2$status
te_st=ex_validation$time
te_y=ex_validation$status
  fit <- fit_lasso(tr_matrix, Surv(tr_st, tr_y), nfolds = 5, rule = "lambda.min")
  tr_times=current_data2$time
  te_times=ex_validation$time
  pred_te_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = te_matrix,pred.at=te_times)
  pred_tr_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = tr_matrix,pred.at=tr_times)
  pred_te=c()
  for(i in 1:nrow(pred_te_matrix)){
    pred_te[i]=pred_te_matrix[i,][which(colnames(pred_te_matrix)==te_times[i])[1]]
  }
  pred_tr=c()
  for(i in 1:nrow(pred_tr_matrix)){
    pred_tr[i]=pred_tr_matrix[i,][which(colnames(pred_tr_matrix)==tr_times[i])[1]]
  }
  harrelC1 <- rcorr.cens(-pred_te,with(ex_validation,Surv(time,status)))
  cindex_test<-harrelC1["C Index"]
  # #calculate brier score:currently cannot be calculated if only have training data
  times=median(current_data2$time)
  Surv.rsp <- Surv(current_data2$time,current_data2$status)
  Surv.rsp.new <- Surv(ex_validation$time,ex_validation$status)
  lp<-pred_tr
  lp.new=pred_te
  bs_test <- predErr(Surv.rsp,Surv.rsp.new,lp,lp.new, time = times)$error
 plotdt_wide2[dim(plotdt_wide2)[1]+1,] =c(round(cindex_test,3),round(bs_test,3),"raw")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
#ggsave("lasso_simomics_with_external_raw.pdf",gg)
```


```{r}
#feature selection
#pure intersection: not many
all_variables=list(result_table$name[which(result_table$freq>=1)],result2_table$name[which(result2_table$freq>=1)],result3_table$name[which(result3_table$freq>=1)],result4_table$name[which(result4_table$freq>=1)],result5_table$name[which(result5_table$freq>=1)],result6_table$name[which(result6_table$freq>=1)],result7_table$name[which(result7_table$freq>=1)],result8_table$name[which(result8_table$freq>=1)],result9_table$name[which(result9_table$freq>=1)],result10_table$name[which(result10_table$freq>=1)],result11_table$name[which(result11_table$freq>=1)],result12_table$name[which(result12_table$freq>=1)],result13_table$name[which(result13_table$freq>=1)],result14_table$name[which(result14_table$freq>=1)],result15_table$name[which(result15_table$freq>=1)],result16_table$name[which(result16_table$freq>=1)],result17_table$name[which(result17_table$freq>=1)])

intersection_variables=Reduce(intersect,all_variables)
intersection_variables

#selected time more than 0.75, freq more than 1.
union_vector=unique(c(result_table$name[which(result_table$freq>1)],result2_table$name[which(result2_table$freq>1)],result3_table$name[which(result3_table$freq>1)],result4_table$name[which(result4_table$freq>1)],result5_table$name[which(result5_table$freq>1)],result6_table$name[which(result6_table$freq>1)],result7_table$name[which(result7_table$freq>1)],result8_table$name[which(result8_table$freq>1)],result9_table$name[which(result9_table$freq>1)],result10_table$name[which(result10_table$freq>1)],result11_table$name[which(result11_table$freq>1)],result12_table$name[which(result12_table$freq>1)],result13_table$name[which(result13_table$freq>1)],result14_table$name[which(result14_table$freq>1)],result15_table$name[which(result15_table$freq>1)],result16_table$name[which(result16_table$freq>1)],result17_table$name[which(result17_table$freq>1)]))


selected_variables=data.frame(matrix(nrow = length(union_vector),ncol = length(all_variables)))
for(i in 1:length(all_variables)){
  for(j in 1:length(union_vector)){
    selected_variables[j,i]=ifelse(union_vector[j]%in%all_variables[[i]],1,0)
  }
}
final_selection=union_vector[which(rowSums(selected_variables)>dim(selected_variables)[2]*(3/4))]
length(final_selection) 
#the number of selected variables are determined by the average of the best performed samples/the bootstrap one
rearranged=union_vector[c(order(rowSums(selected_variables)))]
lasso_variable=final_selection

#add summarise stat
success_rate_fun=function(result){
success_rate=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){success_rate[i]=0}else{success_rate[i]=1}
}
return(sum(success_rate)/length(result))}

lambda_vec_fun=function(result){
lambda_vec=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){lambda_vec[i]=0}else{lambda_vec[i]=result[[i]][[16]]}
}
return(lambda_vec)}

all_train_cindex_fun=function(result){
  all_train_cindex=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cindex[i]=0}else{all_train_cindex[i]=result[[i]][[13]]}
}
return(all_train_cindex)}

all_train_bs_fun=function(result){
  all_train_bs=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_bs[i]=0}else{all_train_bs[i]=result[[i]][[14]]}
}
return(all_train_bs)}

all_train_distance_fun=function(result){
  all_train_distance=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_distance[i]=0}else{all_train_distance[i]=result[[i]][[8]]$statistic}
}
return(all_train_distance)}

all_train_cr_fun=function(result){
  all_train_cr=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cr[i]=0}else{all_train_cr[i]=result[[i]][[1]]}
}
return(all_train_cr)}

#testing
current=heatmap_data[heatmap_data$metric%in%c("cindex","auc","brier_score"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")

lasso_ave=current_wide2$cindex+current_wide2$auc+1-current_wide2$brier_score

dd=cbind.data.frame(rank(-lasso_ave),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3=dd[dd$order%in%c(1,2,3),2]
lasso_cindex=current_wide2$cindex
lasso_auc=current_wide2$auc
lasso_bs=current_wide2$brier_score
lasso_success_rate=c(success_rate_fun(result),success_rate_fun(result2),success_rate_fun(result3),success_rate_fun(result4),success_rate_fun(result5),success_rate_fun(result6),success_rate_fun(result7),success_rate_fun(result8),success_rate_fun(result9),success_rate_fun(result10),success_rate_fun(result11),success_rate_fun(result12),success_rate_fun(result13),success_rate_fun(result14),success_rate_fun(result15),success_rate_fun(result16),success_rate_fun(result17))

lasso_lambda_all=c(lambda_vec_fun(result),lambda_vec_fun(result2),lambda_vec_fun(result3),lambda_vec_fun(result4),lambda_vec_fun(result5),lambda_vec_fun(result6),lambda_vec_fun(result7),lambda_vec_fun(result8),lambda_vec_fun(result9),lambda_vec_fun(result10),lambda_vec_fun(result11),lambda_vec_fun(result12),lambda_vec_fun(result13),lambda_vec_fun(result14),lambda_vec_fun(result15),lambda_vec_fun(result16),lambda_vec_fun(result17))


#external
current=heatmap_data[heatmap_data$metric%in%c("cindex_ex","auc_ex","brier_score_ex"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
lasso_ave_ex=current_wide2$cindex_ex+current_wide2$auc_ex+1-current_wide2$brier_score_ex
lasso_cindex_ex=current_wide2$cindex_ex
lasso_auc_ex=current_wide2$auc_ex
lasso_bs_ex=current_wide2$brier_score_ex

dd=cbind.data.frame(rank(-lasso_ave_ex),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3_ex=dd[dd$order%in%c(1,2,3),2]

#training
current=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
lasso_ave_train=current_wide2$cindex_train+1-current_wide2$brier_score_train
lasso_cindex_train=current_wide2$cindex_train
lasso_bs_train=current_wide2$brier_score_train

dd=cbind.data.frame(rank(-lasso_ave_train),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3_train=dd[dd$order%in%c(1,2,3),2]

#lambda with success rate
lasso_lambda_mean=c(mean(lambda_vec_fun(result)),mean(lambda_vec_fun(result2)),mean(lambda_vec_fun(result3)),mean(lambda_vec_fun(result4)),mean(lambda_vec_fun(result5)),mean(lambda_vec_fun(result6)),mean(lambda_vec_fun(result7)),mean(lambda_vec_fun(result8)),mean(lambda_vec_fun(result9)),mean(lambda_vec_fun(result10)),mean(lambda_vec_fun(result11)),mean(lambda_vec_fun(result12)),mean(lambda_vec_fun(result13)),mean(lambda_vec_fun(result14)),mean(lambda_vec_fun(result15)),mean(lambda_vec_fun(result16)),mean(lambda_vec_fun(result17)))
dd=cbind.data.frame(lasso_success_rate,lasso_lambda_mean,lasso_ave)
dd$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(dd,aes(x=lasso_lambda_mean,y=lasso_success_rate,label=label,color=lasso_ave))+geom_point()+geom_text_repel(size=4)+ggtitle("Lambda versus success rate with performance (ave test)")
#train performance with success rate
dd=cbind.data.frame(lasso_success_rate,lasso_lambda_mean,lasso_ave_train)
dd$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(dd,aes(x=lasso_ave_train,y=lasso_success_rate,label=label,color=lasso_lambda_mean))+geom_point()+geom_text_repel(size=4)+ggtitle("Train performance versus success rate with mean lambda")+theme_bw()
gg=ggplot(dd,aes(x=lasso_ave_train,y=lasso_success_rate,label=label,color=lasso_lambda_mean))+geom_point()+geom_text_repel(size=4)+ggtitle("Train performance versus success rate with mean lambda")+theme_bw()
#ggsave("lasso_simlung_with_trainaverage.pdf",gg)
#train performance with vairability within one method
lasso_train_cindex_all=c(all_train_cindex_fun(result),all_train_cindex_fun(result2),all_train_cindex_fun(result3),all_train_cindex_fun(result4),all_train_cindex_fun(result5),all_train_cindex_fun(result6),all_train_cindex_fun(result7),all_train_cindex_fun(result8),all_train_cindex_fun(result9),all_train_cindex_fun(result10),all_train_cindex_fun(result11),all_train_cindex_fun(result12),all_train_cindex_fun(result13),all_train_cindex_fun(result14),all_train_cindex_fun(result15),all_train_cindex_fun(result16),all_train_cindex_fun(result17))
lasso_train_distance_all=c(all_train_distance_fun(result),all_train_distance_fun(result2),all_train_distance_fun(result3),all_train_distance_fun(result4),all_train_distance_fun(result5),all_train_distance_fun(result6),all_train_distance_fun(result7),all_train_distance_fun(result8),all_train_distance_fun(result9),all_train_distance_fun(result10),all_train_distance_fun(result11),all_train_distance_fun(result12),all_train_distance_fun(result13),all_train_distance_fun(result14),all_train_distance_fun(result15),all_train_distance_fun(result16),all_train_distance_fun(result17))
lasso_train_cr_all=c(all_train_cr_fun(result),all_train_cr_fun(result2),all_train_cr_fun(result3),all_train_cr_fun(result4),all_train_cr_fun(result5),all_train_cr_fun(result6),all_train_cr_fun(result7),all_train_cr_fun(result8),all_train_cr_fun(result9),all_train_cr_fun(result10),all_train_cr_fun(result11),all_train_cr_fun(result12),all_train_cr_fun(result13),all_train_cr_fun(result14),all_train_cr_fun(result15),all_train_cr_fun(result16),all_train_cr_fun(result17))
lasso_train_bs_all=c(all_train_bs_fun(result),all_train_bs_fun(result2),all_train_bs_fun(result3),all_train_bs_fun(result4),all_train_bs_fun(result5),all_train_bs_fun(result6),all_train_bs_fun(result7),all_train_bs_fun(result8),all_train_bs_fun(result9),all_train_bs_fun(result10),all_train_bs_fun(result11),all_train_bs_fun(result12),all_train_bs_fun(result13),all_train_bs_fun(result14),all_train_bs_fun(result15),all_train_bs_fun(result16),all_train_bs_fun(result17))
```

```{r}
stability_selection_variables=list(result_table$name[which(result_table$freq>=lasso_success_rate[1]*100*0.6)],result2_table$name[which(result2_table$freq>=lasso_success_rate[2]*100*0.6)],result3_table$name[which(result3_table$freq>=lasso_success_rate[3]*100*0.6)],result4_table$name[which(result4_table$freq>=lasso_success_rate[4]*100*0.6)],result5_table$name[which(result5_table$freq>=lasso_success_rate[5]*100*0.6)],result6_table$name[which(result6_table$freq>=lasso_success_rate[6]*100*0.6)],result7_table$name[which(result7_table$freq>=lasso_success_rate[7]*100*0.6)],result8_table$name[which(result8_table$freq>=lasso_success_rate[8]*100*0.6)],result9_table$name[which(result9_table$freq>=lasso_success_rate[9]*100*0.6)],result10_table$name[which(result10_table$freq>=lasso_success_rate[10]*100*0.6)],result11_table$name[which(result11_table$freq>=lasso_success_rate[11]*100*0.6)],result12_table$name[which(result12_table$freq>=lasso_success_rate[12]*100*0.6)],result13_table$name[which(result13_table$freq>=lasso_success_rate[13]*100*0.6)],result14_table$name[which(result14_table$freq>=lasso_success_rate[14]*100*0.6)],result15_table$name[which(result15_table$freq>=lasso_success_rate[15]*100*0.6)],result16_table$name[which(result16_table$freq>=lasso_success_rate[16]*100*0.6)],result17_table$name[which(result17_table$freq>=lasso_success_rate[17]*100*0.6)])
#stability_selection_variables
fdr_fun=function(variable_names){
  tp=sum(variable_names%in%c("x.X1","x.X2","x.X3","x.X4" ,"x.X5","x.X6"))
  fp=length(variable_names)-tp
  fdr=fp/(fp+tp)
  return(fdr)
}
stability_selection_fdr=c()
for(i in 1:length(stability_selection_variables)){
  stability_selection_fdr[i]=fdr_fun(unlist(stability_selection_variables[[i]]))
}
stability_selection_fdr

result16_table$name[which(result16_table$freq>=lasso_success_rate[16]*100*0.6)]
result16_table[result16_table$name%in%c("x.X1","x.X2","x.X3","x.X4" ,"x.X5","x.X6"),]
```

```{r fig.height=30,fig.width=30}
dd=cbind.data.frame(lasso_train_cindex_all,lasso_train_distance_all,lasso_lambda_all,lasso_train_cr_all,lasso_train_bs_all)
dd$label=rep(c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),each=100)
# g1=ggplot(dd[1:100,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("bootstrap")
# g2=ggplot(dd[101:200,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.1")
# g3=ggplot(dd[201:300,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.2")
# g4=ggplot(dd[301:400,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.3")
# g5=ggplot(dd[401:500,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.4")
# g6=ggplot(dd[501:600,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.5")
# g7=ggplot(dd[601:700,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.6")
# g8=ggplot(dd[701:800,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.7")
# g9=ggplot(dd[801:900,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.8")
# g10=ggplot(dd[901:1000,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.1")
# g11=ggplot(dd[1001:1100,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.3")
# g12=ggplot(dd[1101:1200,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.5")
# g13=ggplot(dd[1201:1300,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.7")
# g14=ggplot(dd[1301:1400,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.1wr")
# g15=ggplot(dd[1401:1500,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.3wr")
# g16=ggplot(dd[1501:1600,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.5wr")
# g17=ggplot(dd[1601:1700,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.7wr")
# ggarrange(g1,g2,g3,g4,g5,g6,g7,g8,g9,g10,g11,g12,g13,g14,g15,g16,g17,nrow=5,ncol=4)
# 
# g1=ggplot(dd[1:100,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("bootstrap")
# g2=ggplot(dd[101:200,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.1")
# g3=ggplot(dd[201:300,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.2")
# g4=ggplot(dd[301:400,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.3")
# g5=ggplot(dd[401:500,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.4")
# g6=ggplot(dd[501:600,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.5")
# g7=ggplot(dd[601:700,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.6")
# g8=ggplot(dd[701:800,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.7")
# g9=ggplot(dd[801:900,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.8")
# g10=ggplot(dd[901:1000,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.1")
# g11=ggplot(dd[1001:1100,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.3")
# g12=ggplot(dd[1101:1200,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.5")
# g13=ggplot(dd[1201:1300,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.7")
# g14=ggplot(dd[1301:1400,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.1wr")
# g15=ggplot(dd[1401:1500,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.3wr")
# g16=ggplot(dd[1501:1600,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.5wr")
# g17=ggplot(dd[1601:1700,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.7wr")
# ggarrange(g1,g2,g3,g4,g5,g6,g7,g8,g9,g10,g11,g12,g13,g14,g15,g16,g17,nrow=5,ncol=4)

```

```{r fig.height=30,fig.width=30}
dd$label=factor(rep(c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),each=100),levels=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"))
dim(dd)
dd=dd[-which(dd$lasso_train_cindex_all==0),]
dim(dd)
ggplot(dd,aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("train cindex versus all aspects")+facet_wrap(~label,ncol=4)+theme_bw()
ggplot(dd,aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("train bs versus all aspects")+facet_wrap(~label,ncol=4)+theme_bw()
gg=ggplot(dd,aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("train cindex versus all aspects")+facet_wrap(~label,ncol=6)+theme_bw()
#ggsave("lasso_simomics_with_train_cindexvar.pdf",gg,height=10,width=20)
gg=ggplot(dd,aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("train bs versus all aspects")+facet_wrap(~label,ncol=6)+theme_bw()
#ggsave("lasso_simomics_with_train_bsvar.pdf",gg,height=10,width=20)
```

```{r}
#calculate the mean and sd
mean(dd[dd$label=="m0.3","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.3","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.5","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.5","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.7","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.7","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.3wr","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.3wr","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.5wr","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.5wr","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.7wr","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.7wr","lasso_train_cindex_all"])

mean(dd[dd$label=="m0.3","lasso_train_bs_all"])
sd(dd[dd$label=="m0.3","lasso_train_bs_all"])
mean(dd[dd$label=="m0.5","lasso_train_bs_all"])
sd(dd[dd$label=="m0.5","lasso_train_bs_all"])
mean(dd[dd$label=="m0.7","lasso_train_bs_all"])
sd(dd[dd$label=="m0.7","lasso_train_bs_all"])
mean(dd[dd$label=="m0.3wr","lasso_train_bs_all"])
sd(dd[dd$label=="m0.3wr","lasso_train_bs_all"])
mean(dd[dd$label=="m0.5wr","lasso_train_bs_all"])
sd(dd[dd$label=="m0.5wr","lasso_train_bs_all"])
mean(dd[dd$label=="m0.7wr","lasso_train_bs_all"])
sd(dd[dd$label=="m0.7wr","lasso_train_bs_all"])
```


## one simulated data without restriction
```{r}
load("lasso_sim_0.5censoring_0906_100v2.RData")
#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

result_table=get_table(result100[[10]][[1]])[[1]]
result2_table=get_table(result100[[10]][[2]])[[1]]
result3_table=get_table(result100[[10]][[3]])[[1]]
result4_table=get_table(result100[[10]][[4]])[[1]]
result5_table=get_table(result100[[10]][[5]])[[1]]
result6_table=get_table(result100[[10]][[6]])[[1]]
result7_table=get_table(result100[[10]][[7]])[[1]]
result8_table=get_table(result100[[10]][[8]])[[1]]
result9_table=get_table(result100[[10]][[9]])[[1]]
result10_table=get_table(result100[[10]][[10]])[[1]]
result11_table=get_table(result100[[10]][[11]])[[1]]
result12_table=get_table(result100[[10]][[12]])[[1]]
result13_table=get_table(result100[[10]][[13]])[[1]]
result14_table=get_table(result100[[10]][[14]])[[1]]
result15_table=get_table(result100[[10]][[15]])[[1]]
result16_table=get_table(result100[[10]][[16]])[[1]]
result17_table=get_table(result100[[10]][[17]])[[1]]
#get average model performances and number of variables selected
# as.numeric(result[[1]][[1]])
# result[[1]][[3]]
# result[[1]][[4]]

other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

result=result100[[1]][[1]]
result2=result100[[1]][[2]]
result3=result100[[1]][[3]]
result4=result100[[1]][[4]]
result5=result100[[1]][[5]]
result6=result100[[1]][[6]]
result7=result100[[1]][[7]]
result8=result100[[1]][[8]]
result9=result100[[1]][[9]]
result10=result100[[1]][[10]]
result11=result100[[1]][[11]]
result12=result100[[1]][[12]]
result13=result100[[1]][[13]]
result14=result100[[1]][[14]]
result15=result100[[1]][[15]]
result16=result100[[1]][[16]]
result17=result100[[1]][[17]]

heatmap_data=data.frame(nrow=18*17,ncol=18)
heatmap_data[1:306,1]=rep(c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),each=18)
heatmap_data[1:306,2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),17)
heatmap_data[1:306,3]=c(other_table(result,current_data2),other_table(result2,current_data2),other_table(result3,current_data2),other_table(result4,current_data2),other_table(result5,current_data2),other_table(result6,current_data2),other_table(result7,current_data2),other_table(result8,current_data2),other_table(result9,current_data2),other_table(result10,current_data2),other_table(result11,current_data2),other_table(result12,current_data2),other_table(result13,current_data2),other_table(result14,current_data2),other_table(result15,current_data2),other_table(result16,current_data2),other_table(result17,current_data2))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))

#generate the dataset used to plot the heatmap, the rows are the datasets and the columns are metrics: censoring rate, cindex, number of variables selected
gg_heatmap_data=heatmap_data
gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]=gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]/max(gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"])
ggheatmap <-ggplot(gg_heatmap_data, aes(case, metric, fill= value)) + 
 geom_tile(color = "grey")+scale_fill_gradientn(limits = c(0,1),colours = c("#2166AC", "#67A9CF" ,"#D1E5F0", "#FFFFFF","#FDDBC7", "#EF8A62", "#B2182B"))+ theme(aspect.ratio = 1, text = element_text(size = 5), legend.position = "bottom") + labs(y= 'Metrics', x = "Cases", fill = 'Values')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))+
  geom_text(aes(label = round(value,3)), color = "black", size = 4)
ggheatmap

#get all seperate scatter plots
plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with distance_stat")

plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat_test","censoring_rate_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate_test,y=distance_stat_test,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate test with distance_stat test")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=censoring_rate,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("distance_stat with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=num_variables,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with num_variables")+theme_bw()+theme(aspect.ratio = 1)
gg
#ggsave("lasso_lung_without_num_var.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=cindex_train,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with cindex_train")

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
#ggsave("lasso_simomics_without_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
#ggsave("lasso_simomics_without_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
#ggsave("lasso_simomics_without_external.pdf",gg)

#fit model using the entire data on lasso cox and add into the external performance
tr_matrix=data.matrix(current_data2[,!names(current_data2)%in% c("time","status")])
te_matrix=data.matrix(ex_validation[,!names(ex_validation)%in% c("time","status")])
tr_st=current_data2$time
tr_y=current_data2$status
te_st=ex_validation$time
te_y=ex_validation$status
  fit <- fit_lasso(tr_matrix, Surv(tr_st, tr_y), nfolds = 5, rule = "lambda.min")
  tr_times=current_data2$time
  te_times=ex_validation$time
  pred_te_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = te_matrix,pred.at=te_times)
  pred_tr_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = tr_matrix,pred.at=tr_times)
  pred_te=c()
  for(i in 1:nrow(pred_te_matrix)){
    pred_te[i]=pred_te_matrix[i,][which(colnames(pred_te_matrix)==te_times[i])[1]]
  }
  pred_tr=c()
  for(i in 1:nrow(pred_tr_matrix)){
    pred_tr[i]=pred_tr_matrix[i,][which(colnames(pred_tr_matrix)==tr_times[i])[1]]
  }
  harrelC1 <- rcorr.cens(-pred_te,with(ex_validation,Surv(time,status)))
  cindex_test<-harrelC1["C Index"]
  # #calculate brier score:currently cannot be calculated if only have training data
  times=median(current_data2$time)
  Surv.rsp <- Surv(current_data2$time,current_data2$status)
  Surv.rsp.new <- Surv(ex_validation$time,ex_validation$status)
  lp<-pred_tr
  lp.new=pred_te
  bs_test <- predErr(Surv.rsp,Surv.rsp.new,lp,lp.new, time = times)$error
 plotdt_wide2[dim(plotdt_wide2)[1]+1,] =c(round(cindex_test,3),round(bs_test,3),"raw")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
#ggsave("lasso_simomics_without_external_raw.pdf",gg)
```

## all 100 simulated datasets with control
```{r}
load("lasso_sim_0.5censoring_0906_100.RData")
#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

get_table100=function(result,k){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:100){
  for(j in 1:length(result[[i]][[k]]))
  if(length(result[[i]][[k]][[j]])>1){
  coeff_all=c(coeff_all,result[[i]][[k]][[j]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

result_table=get_table100(result100,1)[[1]]
result2_table=get_table100(result100,2)[[1]]
result3_table=get_table100(result100,3)[[1]]
result4_table=get_table100(result100,4)[[1]]
result5_table=get_table100(result100,5)[[1]]
result6_table=get_table100(result100,6)[[1]]
result7_table=get_table100(result100,7)[[1]]
result8_table=get_table100(result100,8)[[1]]
result9_table=get_table100(result100,9)[[1]]
result10_table=get_table100(result100,10)[[1]]
result11_table=get_table100(result100,11)[[1]]
result12_table=get_table100(result100,12)[[1]]
result13_table=get_table100(result100,13)[[1]]
result14_table=get_table100(result100,14)[[1]]
result15_table=get_table100(result100,15)[[1]]
result16_table=get_table100(result100,16)[[1]]
result17_table=get_table100(result100,17)[[1]]

other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

other_table_100=function(result,k){
  tablee=matrix(0,nrow=100,ncol=18)
  for(i in 1:100){
    tablee[i,1:18]=other_table(result[[i]][[k]],current_data2)
  }
  return(colMeans(tablee,na.rm = TRUE))
}

heatmap_data=data.frame(nrow=18*17,ncol=18)
heatmap_data[1:306,1]=rep(c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),each=18)
heatmap_data[1:306,2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),17)
heatmap_data[1:306,3]=c(other_table_100(result100,1),other_table_100(result100,2),other_table_100(result100,3),other_table_100(result100,4),other_table_100(result100,5),other_table_100(result100,6),other_table_100(result100,7),other_table_100(result100,8),other_table_100(result100,9),other_table_100(result100,10),other_table_100(result100,11),other_table_100(result100,12),other_table_100(result100,13),other_table_100(result100,14),other_table_100(result100,15),other_table_100(result100,16),other_table_100(result100,17))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))
#saveRDS(heatmap_data,"simoics_result_data_with.RDS")

#generate the dataset used to plot the heatmap, the rows are the datasets and the columns are metrics: censoring rate, cindex, number of variables selected
gg_heatmap_data=heatmap_data
gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]=gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]/max(gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"])
ggheatmap <-ggplot(gg_heatmap_data, aes(case, metric, fill= value)) + 
 geom_tile(color = "grey")+scale_fill_gradientn(limits = c(0,1),colours = c("#2166AC", "#67A9CF" ,"#D1E5F0", "#FFFFFF","#FDDBC7", "#EF8A62", "#B2182B"))+ theme(aspect.ratio = 1, text = element_text(size = 5), legend.position = "bottom") + labs(y= 'Metrics', x = "Cases", fill = 'Values')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))+
  geom_text(aes(label = round(value,3)), color = "black", size = 4)
ggheatmap

#get all seperate scatter plots
plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with distance_stat")

plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat_test","censoring_rate_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate_test,y=distance_stat_test,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate test with distance_stat test")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=censoring_rate,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("distance_stat with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=num_variables,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with num_variables")+theme_bw()+theme(aspect.ratio = 1)
gg
#ggsave("lasso_simomics_with100_num_var.pdf",gg)


plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=cindex_train,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with cindex_train")

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
#ggsave("lasso_simomics_with100_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
#ggsave("lasso_simomics_with100_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
#ggsave("lasso_simomics_with100_external.pdf",gg)


#add summarise stat
success_rate_fun=function(result){
success_rate=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){success_rate[i]=0}else{success_rate[i]=1}
}
return(sum(success_rate)/length(result))}

success_rate_fun100=function(result,k){
success_rate=c()
for(i in 1:length(result)){
  for(j in 1:length(result[[i]][[k]]))
  if(length(result[[i]][[k]][[j]])==1){success_rate[i]=0}else{success_rate[i]=1}
}
return(sum(success_rate)/length(result))}

lambda_vec_fun=function(result){
lambda_vec=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){lambda_vec[i]=0}else{lambda_vec[i]=result[[i]][[16]]}
}
return(lambda_vec)}

all_train_cindex_fun=function(result){
  all_train_cindex=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cindex[i]=0}else{all_train_cindex[i]=result[[i]][[13]]}
}
return(all_train_cindex)}

all_train_bs_fun=function(result){
  all_train_bs=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_bs[i]=0}else{all_train_bs[i]=result[[i]][[14]]}
}
return(all_train_bs)}

all_train_distance_fun=function(result){
  all_train_distance=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_distance[i]=0}else{all_train_distance[i]=result[[i]][[8]]$statistic}
}
return(all_train_distance)}

all_train_cr_fun=function(result){
  all_train_cr=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cr[i]=0}else{all_train_cr[i]=result[[i]][[1]]}
}
return(all_train_cr)}

#testing
current=heatmap_data[heatmap_data$metric%in%c("cindex","auc","brier_score"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")

lasso_ave=current_wide2$cindex+current_wide2$auc+1-current_wide2$brier_score

dd=cbind.data.frame(rank(-lasso_ave),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3=dd[dd$order%in%c(1,2,3),2]
lasso_cindex=current_wide2$cindex
lasso_auc=current_wide2$auc
lasso_bs=current_wide2$brier_score

lasso_success_rate=c(success_rate_fun100(result100,1),success_rate_fun100(result100,2),success_rate_fun100(result100,3),success_rate_fun100(result100,4),success_rate_fun100(result100,5),success_rate_fun100(result100,6),success_rate_fun100(result100,7),success_rate_fun100(result100,8),success_rate_fun100(result100,9),success_rate_fun100(result100,10),success_rate_fun100(result100,11),success_rate_fun100(result100,12),success_rate_fun100(result100,13),success_rate_fun100(result100,14),success_rate_fun100(result100,15),success_rate_fun100(result100,16),success_rate_fun100(result100,17))



```

```{r eval=FALSE}
stability_selection_variables=list(result_table$name[which(result_table$freq>=lasso_success_rate[1]*10000*0.6)],result2_table$name[which(result2_table$freq>=lasso_success_rate[2]*10000*0.6)],result3_table$name[which(result3_table$freq>=lasso_success_rate[3]*10000*0.6)],result4_table$name[which(result4_table$freq>=lasso_success_rate[4]*10000*0.6)],result5_table$name[which(result5_table$freq>=lasso_success_rate[5]*10000*0.6)],result6_table$name[which(result6_table$freq>=lasso_success_rate[6]*10000*0.6)],result7_table$name[which(result7_table$freq>=lasso_success_rate[7]*10000*0.6)],result8_table$name[which(result8_table$freq>=lasso_success_rate[8]*10000*0.6)],result9_table$name[which(result9_table$freq>=lasso_success_rate[9]*10000*0.6)],result10_table$name[which(result10_table$freq>=lasso_success_rate[10]*10000*0.6)],result11_table$name[which(result11_table$freq>=lasso_success_rate[11]*10000*0.6)],result12_table$name[which(result12_table$freq>=lasso_success_rate[12]*10000*0.6)],result13_table$name[which(result13_table$freq>=lasso_success_rate[13]*10000*0.6)],result14_table$name[which(result14_table$freq>=lasso_success_rate[14]*10000*0.6)],result15_table$name[which(result15_table$freq>=lasso_success_rate[15]*10000*0.6)],result16_table$name[which(result16_table$freq>=lasso_success_rate[16]*10000*0.6)],result17_table$name[which(result17_table$freq>=lasso_success_rate[17]*10000*0.6)])
#stability_selection_variables
fdr_fun=function(variable_names){
  tp=sum(variable_names%in%c("ascites","edema","bili" ,"albumin","copper","stage"))
  fp=length(variable_names)-tp
  fdr=fp/(fp+tp)
  return(fdr)
}
stability_selection_fdr=c()
for(i in 1:length(stability_selection_variables)){
  stability_selection_fdr[i]=fdr_fun(unlist(stability_selection_variables[[i]]))
}
stability_selection_fdr
```


## all 100 simulated datasets without control
```{r}
load("lasso_sim_0.5censoring_0906_100v2.RData")
#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

get_table100=function(result,k){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:100){
  for(j in 1:length(result[[i]][[k]]))
  if(length(result[[i]][[k]][[j]])>1){
  coeff_all=c(coeff_all,result[[i]][[k]][[j]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

result_table=get_table100(result100,1)[[1]]
result2_table=get_table100(result100,2)[[1]]
result3_table=get_table100(result100,3)[[1]]
result4_table=get_table100(result100,4)[[1]]
result5_table=get_table100(result100,5)[[1]]
result6_table=get_table100(result100,6)[[1]]
result7_table=get_table100(result100,7)[[1]]
result8_table=get_table100(result100,8)[[1]]
result9_table=get_table100(result100,9)[[1]]
result10_table=get_table100(result100,10)[[1]]
result11_table=get_table100(result100,11)[[1]]
result12_table=get_table100(result100,12)[[1]]
result13_table=get_table100(result100,13)[[1]]
result14_table=get_table100(result100,14)[[1]]
result15_table=get_table100(result100,15)[[1]]
result16_table=get_table100(result100,16)[[1]]
result17_table=get_table100(result100,17)[[1]]

other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

other_table_100=function(result,k){
  tablee=matrix(0,nrow=100,ncol=18)
  for(i in 1:100){
    tablee[i,1:18]=other_table(result[[i]][[k]],current_data2)
  }
  return(colMeans(tablee,na.rm = TRUE))
}

heatmap_data=data.frame(nrow=18*17,ncol=18)
heatmap_data[1:306,1]=rep(c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),each=18)
heatmap_data[1:306,2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),17)
heatmap_data[1:306,3]=c(other_table_100(result100,1),other_table_100(result100,2),other_table_100(result100,3),other_table_100(result100,4),other_table_100(result100,5),other_table_100(result100,6),other_table_100(result100,7),other_table_100(result100,8),other_table_100(result100,9),other_table_100(result100,10),other_table_100(result100,11),other_table_100(result100,12),other_table_100(result100,13),other_table_100(result100,14),other_table_100(result100,15),other_table_100(result100,16),other_table_100(result100,17))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))
#saveRDS(heatmap_data,"simoics_result_data_without.RDS")

#generate the dataset used to plot the heatmap, the rows are the datasets and the columns are metrics: censoring rate, cindex, number of variables selected
gg_heatmap_data=heatmap_data
gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]=gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]/max(gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"])
ggheatmap <-ggplot(gg_heatmap_data, aes(case, metric, fill= value)) + 
 geom_tile(color = "grey")+scale_fill_gradientn(limits = c(0,1),colours = c("#2166AC", "#67A9CF" ,"#D1E5F0", "#FFFFFF","#FDDBC7", "#EF8A62", "#B2182B"))+ theme(aspect.ratio = 1, text = element_text(size = 5), legend.position = "bottom") + labs(y= 'Metrics', x = "Cases", fill = 'Values')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))+
  geom_text(aes(label = round(value,3)), color = "black", size = 4)
ggheatmap

#get all seperate scatter plots
plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with distance_stat")

plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat_test","censoring_rate_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate_test,y=distance_stat_test,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate test with distance_stat test")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=censoring_rate,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("distance_stat with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=num_variables,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with num_variables")+theme_bw()+theme(aspect.ratio = 1)
gg
#ggsave("lasso_simomics_without100_num_var.pdf",gg)


plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=cindex_train,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with cindex_train")

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
#ggsave("lasso_simomics_without100_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
#ggsave("lasso_simomics_without100_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
#ggsave("lasso_simomics_without100_external.pdf",gg)


#add summarise stat
success_rate_fun=function(result){
success_rate=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){success_rate[i]=0}else{success_rate[i]=1}
}
return(sum(success_rate)/length(result))}

success_rate_fun100=function(result,k){
success_rate=c()
for(i in 1:length(result)){
  for(j in 1:length(result[[i]][[k]]))
  if(length(result[[i]][[k]][[j]])==1){success_rate[i]=0}else{success_rate[i]=1}
}
return(sum(success_rate)/length(result))}

lambda_vec_fun=function(result){
lambda_vec=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){lambda_vec[i]=0}else{lambda_vec[i]=result[[i]][[16]]}
}
return(lambda_vec)}

all_train_cindex_fun=function(result){
  all_train_cindex=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cindex[i]=0}else{all_train_cindex[i]=result[[i]][[13]]}
}
return(all_train_cindex)}

all_train_bs_fun=function(result){
  all_train_bs=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_bs[i]=0}else{all_train_bs[i]=result[[i]][[14]]}
}
return(all_train_bs)}

all_train_distance_fun=function(result){
  all_train_distance=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_distance[i]=0}else{all_train_distance[i]=result[[i]][[8]]$statistic}
}
return(all_train_distance)}

all_train_cr_fun=function(result){
  all_train_cr=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cr[i]=0}else{all_train_cr[i]=result[[i]][[1]]}
}
return(all_train_cr)}

#testing
current=heatmap_data[heatmap_data$metric%in%c("cindex","auc","brier_score"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("bootstrap","c0.1","c0.2","c0.3","c0.4","c0.5","c0.6","c0.7","c0.8","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr")

lasso_ave=current_wide2$cindex+current_wide2$auc+1-current_wide2$brier_score

dd=cbind.data.frame(rank(-lasso_ave),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3=dd[dd$order%in%c(1,2,3),2]
lasso_cindex=current_wide2$cindex
lasso_auc=current_wide2$auc
lasso_bs=current_wide2$brier_score

lasso_success_rate=c(success_rate_fun100(result100,1),success_rate_fun100(result100,2),success_rate_fun100(result100,3),success_rate_fun100(result100,4),success_rate_fun100(result100,5),success_rate_fun100(result100,6),success_rate_fun100(result100,7),success_rate_fun100(result100,8),success_rate_fun100(result100,9),success_rate_fun100(result100,10),success_rate_fun100(result100,11),success_rate_fun100(result100,12),success_rate_fun100(result100,13),success_rate_fun100(result100,14),success_rate_fun100(result100,15),success_rate_fun100(result100,16),success_rate_fun100(result100,17))



```

```{r eval=FALSE}
stability_selection_variables=list(result_table$name[which(result_table$freq>=lasso_success_rate[1]*10000*0.6)],result2_table$name[which(result2_table$freq>=lasso_success_rate[2]*10000*0.6)],result3_table$name[which(result3_table$freq>=lasso_success_rate[3]*10000*0.6)],result4_table$name[which(result4_table$freq>=lasso_success_rate[4]*10000*0.6)],result5_table$name[which(result5_table$freq>=lasso_success_rate[5]*10000*0.6)],result6_table$name[which(result6_table$freq>=lasso_success_rate[6]*10000*0.6)],result7_table$name[which(result7_table$freq>=lasso_success_rate[7]*10000*0.6)],result8_table$name[which(result8_table$freq>=lasso_success_rate[8]*10000*0.6)],result9_table$name[which(result9_table$freq>=lasso_success_rate[9]*10000*0.6)],result10_table$name[which(result10_table$freq>=lasso_success_rate[10]*10000*0.6)],result11_table$name[which(result11_table$freq>=lasso_success_rate[11]*10000*0.6)],result12_table$name[which(result12_table$freq>=lasso_success_rate[12]*10000*0.6)],result13_table$name[which(result13_table$freq>=lasso_success_rate[13]*10000*0.6)],result14_table$name[which(result14_table$freq>=lasso_success_rate[14]*10000*0.6)],result15_table$name[which(result15_table$freq>=lasso_success_rate[15]*10000*0.6)],result16_table$name[which(result16_table$freq>=lasso_success_rate[16]*10000*0.6)],result17_table$name[which(result17_table$freq>=lasso_success_rate[17]*10000*0.6)])
#stability_selection_variables
fdr_fun=function(variable_names){
  tp=sum(variable_names%in%c("ascites","edema","bili" ,"albumin","copper","stage"))
  fp=length(variable_names)-tp
  fdr=fp/(fp+tp)
  return(fdr)
}
stability_selection_fdr=c()
for(i in 1:length(stability_selection_variables)){
  stability_selection_fdr[i]=fdr_fun(unlist(stability_selection_variables[[i]]))
}
stability_selection_fdr
```

## get both loaded with comparison
```{r}
heatmapdt1=readRDS("simoics_result_data_with.RDS")
heatmapdt2=readRDS("simoics_result_data_without.RDS")
# heatmapdt1$name=rep("with_restriction",dim(heatmapdt1)[1])
# heatmapdt2$name=rep("without_restriction",dim(heatmapdt2)[1])

plotdt1=heatmapdt1[heatmapdt1$metric%in%c("cindex_train","brier_score_train")&heatmapdt1$case%in%c("bootstrap","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),]
plotdt2=heatmapdt2[heatmapdt2$metric%in%c("cindex_train","brier_score_train")&heatmapdt1$case%in%c("bootstrap","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),]
plotdt1=reshape(plotdt1,idvar="case",timevar="metric",direction = "wide")
plotdt2=reshape(plotdt2,idvar="case",timevar="metric",direction = "wide")
plotdt=rbind.data.frame(plotdt1,plotdt2)
plotdt$name=c(rep("with_restriction",dim(plotdt1)[1]),rep("without_restriction",dim(plotdt2)[1]))
gg=ggplot(plotdt,aes(x=value.brier_score_train,y=value.cindex_train,color=name,label=case))+geom_point()+geom_text_repel(size=4)  + theme_bw()+ggtitle("Prediction performances in train")
gg
#ggsave("lasso_simomics_100compare_train.pdf",gg)    

plotdt1=heatmapdt1[heatmapdt1$metric%in%c("cindex","brier_score")&heatmapdt1$case%in%c("bootstrap","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),]
plotdt2=heatmapdt2[heatmapdt2$metric%in%c("cindex","brier_score")&heatmapdt1$case%in%c("bootstrap","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),]
plotdt1=reshape(plotdt1,idvar="case",timevar="metric",direction = "wide")
plotdt2=reshape(plotdt2,idvar="case",timevar="metric",direction = "wide")
plotdt=rbind.data.frame(plotdt1,plotdt2)
plotdt$name=c(rep("with_restriction",dim(plotdt1)[1]),rep("without_restriction",dim(plotdt2)[1]))
gg=ggplot(plotdt,aes(x=value.brier_score,y=value.cindex,color=name,label=case))+geom_point()+geom_text_repel(size=4)  + theme_bw()+ggtitle("Prediction performances in test")
gg
#ggsave("lasso_simomics_100compare_test.pdf",gg)   

plotdt1=heatmapdt1[heatmapdt1$metric%in%c("cindex_ex","brier_score_ex")&heatmapdt1$case%in%c("bootstrap","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),]
plotdt2=heatmapdt2[heatmapdt2$metric%in%c("cindex_ex","brier_score_ex")&heatmapdt1$case%in%c("bootstrap","m0.1","m0.3","m0.5","m0.7","m0.1wr","m0.3wr","m0.5wr","m0.7wr"),]
plotdt1=reshape(plotdt1,idvar="case",timevar="metric",direction = "wide")
plotdt2=reshape(plotdt2,idvar="case",timevar="metric",direction = "wide")
plotdt=rbind.data.frame(plotdt1,plotdt2)
plotdt$name=c(rep("with_restriction",dim(plotdt1)[1]),rep("without_restriction",dim(plotdt2)[1]))
gg=ggplot(plotdt,aes(x=value.brier_score_ex,y=value.cindex_ex,color=name,label=case))+geom_point()+geom_text_repel(size=4)  + theme_bw()+ggtitle("Prediction performances in external data")
gg
#ggsave("lasso_simomics_100compare_external.pdf",gg)   
```


## get both loaded with comparison with adding 0.2.
```{r eval=FALSE}

sim_dt_list=readRDS("sim_data_list0.5censoring_0906.RDS")
result100=list()
for(i in 1:100){
sim_dt=sim_dt_list[[i]]
sim_dt2=sim_dt
dim(sim_dt2)#280
set.seed(230906)
rownum=sample(nrow(sim_dt2),nrow(sim_dt2)*0.2,replace = FALSE)
ex_validation=sim_dt2[rownum,]
current_data2=sim_dt2[-rownum,]
dim(ex_validation)#56
dim(current_data2)#224
current_data2_new=current_data2[,!colnames(current_data2)%in% c("time","status")]
current_data2_new=apply(current_data2_new, 2, function(x) scale(x,scale = TRUE))
current_data2_new2=cbind.data.frame(current_data2_new,current_data2[,colnames(current_data2)%in% c("time","status")])
#round(colMeans(current_data2_new2),3)
current_data2=current_data2_new2

ex_validation_new=ex_validation[,!colnames(ex_validation)%in% c("time","status")]
ex_validation_new=apply(ex_validation_new, 2, function(x) scale(x,scale = TRUE))
ex_validation_new2=cbind.data.frame(ex_validation_new,ex_validation[,colnames(ex_validation)%in% c("time","status")])
#round(colMeans(ex_validation_new2),3)
ex_validation=ex_validation_new2

timess=seq(as.numeric(summary(current_data2$time)[2]),as.numeric(summary(current_data2$time)[5]),(as.numeric(summary(current_data2$time)[5])-as.numeric(summary(current_data2$time)[2]))/9)
resultnew0.2wc=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
resultnew0.2=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result100[[i]]=list(resultnew0.2wc,resultnew0.2)
}
save(result100,file="simoics_result_extra.RDS")

other_table_100=function(result,k){
  tablee=matrix(0,nrow=100,ncol=18)
  for(i in 1:100){
    tablee[i,1:18]=other_table(result[[i]][[k]],current_data2)
  }
  return(colMeans(tablee,na.rm = TRUE))
}

add0.2wc=other_table_100(result100,1)
add0.2=other_table_100(result100,2)
names(add0.2)=c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex")
```


```{r}
heatmapdt1=readRDS("simoics_result_data_with.RDS")
prepared_add0.2wc=rbind.data.frame(c("m0.2","cindex",0.90130476),c("m0.2","brier_score",0.20729772),c("m0.2","cindex_train",0.85006374),c("m0.2","brier_score_train",0.27262705),c("m0.2","cindex_ex",0.90946852),c("m0.2","brier_score_ex",0.21973503))
colnames(prepared_add0.2wc)=colnames(heatmapdt1)
heatmapdt1=rbind.data.frame(heatmapdt1,prepared_add0.2wc)
heatmapdt1$value=round(as.numeric(heatmapdt1$value),3)
heatmapdt2=readRDS("simoics_result_data_without.RDS")
prepared_add0.2=rbind.data.frame(c("m0.2","cindex",0.88678318),c("m0.2","brier_score",0.23109752),c("m0.2","cindex_train",0.78894869),c("m0.2","brier_score_train",0.30867087),c("m0.2","cindex_ex",0.89772648),c("m0.2","brier_score_ex",0.23793987))
colnames(prepared_add0.2)=colnames(heatmapdt1)
heatmapdt2=rbind.data.frame(heatmapdt2,prepared_add0.2)
heatmapdt2$value=round(as.numeric(heatmapdt2$value),3)
# heatmapdt1$name=rep("with_restriction",dim(heatmapdt1)[1])
# heatmapdt2$name=rep("without_restriction",dim(heatmapdt2)[1])

plotdt1=heatmapdt1[heatmapdt1$metric%in%c("cindex_train","brier_score_train")&heatmapdt1$case%in%c("m0.1","m0.2","m0.3","m0.5","m0.7"),]
plotdt2=heatmapdt2[heatmapdt2$metric%in%c("cindex_train","brier_score_train")&heatmapdt2$case%in%c("m0.1","m0.2","m0.3","m0.5","m0.7"),]
plotdt1=reshape(plotdt1,idvar="case",timevar="metric",direction = "wide")
plotdt2=reshape(plotdt2,idvar="case",timevar="metric",direction = "wide")
plotdt=rbind.data.frame(plotdt1,plotdt2)
plotdt$name=c(rep("with_restriction",dim(plotdt1)[1]),rep("without_restriction",dim(plotdt2)[1]))
gg=ggplot(plotdt,aes(x=value.brier_score_train,y=value.cindex_train,color=name,label=case))+geom_point()+geom_text_repel(size=4)  + theme_bw()+ggtitle("Prediction performances in train")+theme(aspect.ratio = 1)
gg
ggsave("lasso_simomics_100compare_trainv2.pdf",gg)    

plotdt1=heatmapdt1[heatmapdt1$metric%in%c("cindex","brier_score")&heatmapdt1$case%in%c("m0.1","m0.2","m0.3","m0.5","m0.7"),]
plotdt2=heatmapdt2[heatmapdt2$metric%in%c("cindex","brier_score")&heatmapdt2$case%in%c("m0.1","m0.2","m0.3","m0.5","m0.7"),]
plotdt1=reshape(plotdt1,idvar="case",timevar="metric",direction = "wide")
plotdt2=reshape(plotdt2,idvar="case",timevar="metric",direction = "wide")
plotdt=rbind.data.frame(plotdt1,plotdt2)
plotdt$name=c(rep("with_restriction",dim(plotdt1)[1]),rep("without_restriction",dim(plotdt2)[1]))
gg=ggplot(plotdt,aes(x=value.brier_score,y=value.cindex,color=name,label=case))+geom_point()+geom_text_repel(size=4)  + theme_bw()+ggtitle("Prediction performances in test")+theme(aspect.ratio = 1)
gg
ggsave("lasso_simomics_100compare_testv2.pdf",gg)   

plotdt1=heatmapdt1[heatmapdt1$metric%in%c("cindex_ex","brier_score_ex")&heatmapdt1$case%in%c("m0.1","m0.2","m0.3","m0.5","m0.7"),]
plotdt2=heatmapdt2[heatmapdt2$metric%in%c("cindex_ex","brier_score_ex")&heatmapdt2$case%in%c("m0.1","m0.2","m0.3","m0.5","m0.7"),]
plotdt1=reshape(plotdt1,idvar="case",timevar="metric",direction = "wide")
plotdt2=reshape(plotdt2,idvar="case",timevar="metric",direction = "wide")
plotdt=rbind.data.frame(plotdt1,plotdt2)
plotdt$name=c(rep("with_restriction",dim(plotdt1)[1]),rep("without_restriction",dim(plotdt2)[1]))
gg=ggplot(plotdt,aes(x=value.brier_score_ex,y=value.cindex_ex,color=name,label=case))+geom_point()+geom_text_repel(size=4)  + theme_bw()+ggtitle("Prediction performances in external data")+theme(aspect.ratio = 1)
gg
ggsave("lasso_simomics_100compare_externalv2.pdf",gg)   
```



