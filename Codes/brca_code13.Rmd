---
title: "Stability selection for censored biomedical and bioinformatics data"
author: "Yunwei Zhang"
date: “`r paste0('Initiated on 20231107, compiled on ', format(Sys.time(), '%Y %b %d'))`”
output:
  
  html_document:
    code_folding: hide
    fig_height: 8
    fig_width: 12
    highlight: tango
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '4'
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE,message = FALSE)
#usethis::edit_r_environ()
#R_MAX_VSIZE=700Gb
```

This file is to get results from the brca dataset. this file is a modification of code 12 for the acc data. 
```{r}
.libPaths("/dskh/nobackup/yunwei/stability_selection_codes/stability_selection_library")
setwd("/dskh/nobackup/yunwei/stability_selection_codes")
library(inline)
openblas.set.num.threads <- cfunction( signature(ipt="integer"),
                                       body = "openblas_set_num_threads(*ipt);",
                                       otherdefs = c ("extern void openblas_set_num_threads(int);"),
                                       libargs = c ("/usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3"),
                                       language = "C",
                                       convention = ".C"
)
openblas.set.num.threads(1)

#install.packages("Matrix")
#library(Matrix)
library(survAUC)
library(reshape2)
library(ggplot2)
library(readxl)
library(ggpubr)
library(dplyr)
library(tidyverse)
library(mstate)
library(MASS)
library(survival)
library(MatchIt)
library(mice)
library(DT)
library(EnvStats)
library(pbmcapply)
library(FNN)

library(pec)
library(MultiAssayExperiment)
library(TCGAbiolinks)

library(survivalROC)
library(survival)
#library(CoxBoost) #archrived package
library(limma)
library(survivalsvm)
library(survminer)
library(randomForestSRC)
library(glmnet)
library(rms)
library(penalized)
library(riskRegression)
library(pROC)
library(ROCR)
library(cvTools)
library(parallel)
library(MTLR)
library(icenReg)#was trying to get data (miceData), however, there is no covariates with that interval censored data
library(mcsurvdata)
library(ExperimentHub)
library(hdnom)
library(Hmisc)
library(ggrepel)
```

```{r}
source("functions.R")
#auxilary selection functions

stability_selection_fun1=function(i,data,ex_validation,timess){
  set.seed(i)
  updated_data=bootstrap_fun(data,i)
  censoring_rate_train=table(updated_data[[1]]$status)[1]/(table(updated_data[[1]]$status)[1]+table(updated_data[[1]]$status)[2])
  censoring_rate_test=table(updated_data[[2]]$status)[1]/(table(updated_data[[2]]$status)[1]+table(updated_data[[2]]$status)[2])
  rr=lasso_feature_selection_withoutcal(updated_data,ex_validation,timess)
  coeff=rr[[1]]
  cindex=rr[[2]]
  length_coef=rr[[3]]
  bs=rr[[4]]
  auc=rr[[5]]
  distance_train=ks.test(updated_data[[1]]$time,data$time)
  distance_test=ks.test(updated_data[[2]]$time,data$time)
  lambda=rr[[16]]
  npasses=rr[[17]]
  devratio=rr[[18]]
  cindex_train=rr[[19]]
  bs_train=rr[[20]]
  cindex_ex=rr[[21]]
  bs_ex=rr[[22]]
  auc_ex=rr[[23]]
  auc_ex_all=c(unlist(rr[[24]]),unlist(rr[[25]]),unlist(rr[[26]]),unlist(rr[[27]]),unlist(rr[[28]]),unlist(rr[[29]]),unlist(rr[[30]]),unlist(rr[[31]]),unlist(rr[[32]]),unlist(rr[[33]]))
  auc_te_all=c(unlist(rr[[6]]),unlist(rr[[7]]),unlist(rr[[8]]),unlist(rr[[9]]),unlist(rr[[10]]),unlist(rr[[11]]),unlist(rr[[12]]),unlist(rr[[13]]),unlist(rr[[14]]),unlist(rr[[15]]))
  # cal_train=rr[[34]]
  # cal_test=rr[[35]]
  # cal_ex=rr[[36]]
  # return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all,cal_train,cal_test,cal_ex))
  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all))
}

#write into one function to run in parallell
stability_selection_fun2=function(i,data,ex_validation,timess,prob){
  set.seed(i)
  updated_data=bootstrap_fun2(data,i,desired_proportion_A=prob)
  censoring_rate_train=table(updated_data[[1]]$status)[1]/(table(updated_data[[1]]$status)[1]+table(updated_data[[1]]$status)[2])
  censoring_rate_test=table(updated_data[[2]]$status)[1]/(table(updated_data[[2]]$status)[1]+table(updated_data[[2]]$status)[2])
  rr=lasso_feature_selection_withoutcal(updated_data,ex_validation,timess)
  coeff=rr[[1]]
  cindex=rr[[2]]
  length_coef=rr[[3]]
  bs=rr[[4]]
  auc=rr[[5]]
  distance_train=ks.test(updated_data[[1]]$time,data$time)
  distance_test=ks.test(updated_data[[2]]$time,data$time)
  lambda=rr[[16]]
  npasses=rr[[17]]
  devratio=rr[[18]]
  cindex_train=rr[[19]]
  bs_train=rr[[20]]
  cindex_ex=rr[[21]]
  bs_ex=rr[[22]]
  auc_ex=rr[[23]]
  auc_ex_all=c(unlist(rr[[24]]),unlist(rr[[25]]),unlist(rr[[26]]),unlist(rr[[27]]),unlist(rr[[28]]),unlist(rr[[29]]),unlist(rr[[30]]),unlist(rr[[31]]),unlist(rr[[32]]),unlist(rr[[33]]))
  auc_te_all=c(unlist(rr[[6]]),unlist(rr[[7]]),unlist(rr[[8]]),unlist(rr[[9]]),unlist(rr[[10]]),unlist(rr[[11]]),unlist(rr[[12]]),unlist(rr[[13]]),unlist(rr[[14]]),unlist(rr[[15]]))
  # cal_train=rr[[34]]
  # cal_test=rr[[35]]
  # cal_ex=rr[[36]]
  # return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all,cal_train,cal_test,cal_ex))
  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all))
}

#write into one function to run in parallell
stability_selection_fun3=purrr::possibly(function(i,data,ex_validation,timess,m_percentage){
  set.seed(i)
  updated_data=moutofn_bootstrap_fun4(data,i,m_percentage)
  censoring_rate_train=table(updated_data[[1]]$status)[1]/(table(updated_data[[1]]$status)[1]+table(updated_data[[1]]$status)[2])
  censoring_rate_test=table(updated_data[[2]]$status)[1]/(table(updated_data[[2]]$status)[1]+table(updated_data[[2]]$status)[2])
  rr=lasso_feature_selection_withoutcal(updated_data,ex_validation,timess)
  coeff=rr[[1]]
  cindex=rr[[2]]
  length_coef=rr[[3]]
  bs=rr[[4]]
  auc=rr[[5]]
  distance_train=ks.test(updated_data[[1]]$time,data$time)
  distance_test=ks.test(updated_data[[2]]$time,data$time)
  lambda=rr[[16]]
  npasses=rr[[17]]
  devratio=rr[[18]]
  cindex_train=rr[[19]]
  bs_train=rr[[20]]
  cindex_ex=rr[[21]]
  bs_ex=rr[[22]]
  auc_ex=rr[[23]]
  auc_ex_all=c(unlist(rr[[24]]),unlist(rr[[25]]),unlist(rr[[26]]),unlist(rr[[27]]),unlist(rr[[28]]),unlist(rr[[29]]),unlist(rr[[30]]),unlist(rr[[31]]),unlist(rr[[32]]),unlist(rr[[33]]))
  auc_te_all=c(unlist(rr[[6]]),unlist(rr[[7]]),unlist(rr[[8]]),unlist(rr[[9]]),unlist(rr[[10]]),unlist(rr[[11]]),unlist(rr[[12]]),unlist(rr[[13]]),unlist(rr[[14]]),unlist(rr[[15]]))
 # cal_train=rr[[34]]
 #  cal_test=rr[[35]]
 #  cal_ex=rr[[36]]
 #  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all,cal_train,cal_test,cal_ex))
  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all))
},otherwise = NA)

stability_selection_fun4=purrr::possibly(function(i,data,ex_validation,timess,m_percentage){
  set.seed(i)
  updated_data=moutofn_bootstrap_fun_wr4(data,i,m_percentage)
  censoring_rate_train=table(updated_data[[1]]$status)[1]/(table(updated_data[[1]]$status)[1]+table(updated_data[[1]]$status)[2])
  censoring_rate_test=table(updated_data[[2]]$status)[1]/(table(updated_data[[2]]$status)[1]+table(updated_data[[2]]$status)[2])
  rr=lasso_feature_selection_withoutcal(updated_data,ex_validation,timess)
  coeff=rr[[1]]
  cindex=rr[[2]]
  length_coef=rr[[3]]
  bs=rr[[4]]
  auc=rr[[5]]
  distance_train=ks.test(updated_data[[1]]$time,data$time)
  distance_test=ks.test(updated_data[[2]]$time,data$time)
  lambda=rr[[16]]
  npasses=rr[[17]]
  devratio=rr[[18]]
  cindex_train=rr[[19]]
  bs_train=rr[[20]]
  cindex_ex=rr[[21]]
  bs_ex=rr[[22]]
  auc_ex=rr[[23]]
  auc_ex_all=c(unlist(rr[[24]]),unlist(rr[[25]]),unlist(rr[[26]]),unlist(rr[[27]]),unlist(rr[[28]]),unlist(rr[[29]]),unlist(rr[[30]]),unlist(rr[[31]]),unlist(rr[[32]]),unlist(rr[[33]]))
  auc_te_all=c(unlist(rr[[6]]),unlist(rr[[7]]),unlist(rr[[8]]),unlist(rr[[9]]),unlist(rr[[10]]),unlist(rr[[11]]),unlist(rr[[12]]),unlist(rr[[13]]),unlist(rr[[14]]),unlist(rr[[15]]))
 # cal_train=rr[[34]]
 #  cal_test=rr[[35]]
 #  cal_ex=rr[[36]]
 #  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all,cal_train,cal_test,cal_ex))
  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all))
},otherwise = NA)

#without restriction
#write into one function to run in parallell
stability_selection_fun5=purrr::possibly(function(i,data,ex_validation,timess,m_percentage){
  set.seed(i)
  updated_data=moutofn_bootstrap_fun(data,i,m_percentage)
  censoring_rate_train=table(updated_data[[1]]$status)[1]/(table(updated_data[[1]]$status)[1]+table(updated_data[[1]]$status)[2])
  censoring_rate_test=table(updated_data[[2]]$status)[1]/(table(updated_data[[2]]$status)[1]+table(updated_data[[2]]$status)[2])
  rr=lasso_feature_selection_withoutcal(updated_data,ex_validation,timess)
  coeff=rr[[1]]
  cindex=rr[[2]]
  length_coef=rr[[3]]
  bs=rr[[4]]
  auc=rr[[5]]
  distance_train=ks.test(updated_data[[1]]$time,data$time)
  distance_test=ks.test(updated_data[[2]]$time,data$time)
  lambda=rr[[16]]
  npasses=rr[[17]]
  devratio=rr[[18]]
  cindex_train=rr[[19]]
  bs_train=rr[[20]]
  cindex_ex=rr[[21]]
  bs_ex=rr[[22]]
  auc_ex=rr[[23]]
  auc_ex_all=c(unlist(rr[[24]]),unlist(rr[[25]]),unlist(rr[[26]]),unlist(rr[[27]]),unlist(rr[[28]]),unlist(rr[[29]]),unlist(rr[[30]]),unlist(rr[[31]]),unlist(rr[[32]]),unlist(rr[[33]]))
  auc_te_all=c(unlist(rr[[6]]),unlist(rr[[7]]),unlist(rr[[8]]),unlist(rr[[9]]),unlist(rr[[10]]),unlist(rr[[11]]),unlist(rr[[12]]),unlist(rr[[13]]),unlist(rr[[14]]),unlist(rr[[15]]))
 # cal_train=rr[[34]]
 #  cal_test=rr[[35]]
 #  cal_ex=rr[[36]]
 #  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all,cal_train,cal_test,cal_ex))
  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all))
},otherwise = NA)

stability_selection_fun6=purrr::possibly(function(i,data,ex_validation,timess,m_percentage){
  set.seed(i)
  updated_data=moutofn_bootstrap_fun_wr(data,i,m_percentage)
  censoring_rate_train=table(updated_data[[1]]$status)[1]/(table(updated_data[[1]]$status)[1]+table(updated_data[[1]]$status)[2])
  censoring_rate_test=table(updated_data[[2]]$status)[1]/(table(updated_data[[2]]$status)[1]+table(updated_data[[2]]$status)[2])
  rr=lasso_feature_selection_withoutcal(updated_data,ex_validation,timess)
  coeff=rr[[1]]
  cindex=rr[[2]]
  length_coef=rr[[3]]
  bs=rr[[4]]
  auc=rr[[5]]
  distance_train=ks.test(updated_data[[1]]$time,data$time)
  distance_test=ks.test(updated_data[[2]]$time,data$time)
  lambda=rr[[16]]
  npasses=rr[[17]]
  devratio=rr[[18]]
  cindex_train=rr[[19]]
  bs_train=rr[[20]]
  cindex_ex=rr[[21]]
  bs_ex=rr[[22]]
  auc_ex=rr[[23]]
  auc_ex_all=c(unlist(rr[[24]]),unlist(rr[[25]]),unlist(rr[[26]]),unlist(rr[[27]]),unlist(rr[[28]]),unlist(rr[[29]]),unlist(rr[[30]]),unlist(rr[[31]]),unlist(rr[[32]]),unlist(rr[[33]]))
  auc_te_all=c(unlist(rr[[6]]),unlist(rr[[7]]),unlist(rr[[8]]),unlist(rr[[9]]),unlist(rr[[10]]),unlist(rr[[11]]),unlist(rr[[12]]),unlist(rr[[13]]),unlist(rr[[14]]),unlist(rr[[15]]))
 # cal_train=rr[[34]]
 #  cal_test=rr[[35]]
 #  cal_ex=rr[[36]]
 #  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all,cal_train,cal_test,cal_ex))
  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all))
},otherwise = NA)

#write into one function to run in parallell
stability_selection_fun7=purrr::possibly(function(i,data,ex_validation,timess,prob){
  set.seed(i)
  updated_data=bootstrap_fun3(data,i,desired_proportion_A=prob)
  censoring_rate_train=table(updated_data[[1]]$status)[1]/(table(updated_data[[1]]$status)[1]+table(updated_data[[1]]$status)[2])
  censoring_rate_test=table(updated_data[[2]]$status)[1]/(table(updated_data[[2]]$status)[1]+table(updated_data[[2]]$status)[2])
  updated_data_new1=updated_data[[1]]
    updated_data_new1=updated_data_new1[,-which(colnames(updated_data_new1)=="control_var")]
   updated_data_new2=updated_data[[2]]
    updated_data_new2=updated_data_new2[,-which(colnames(updated_data_new2)=="control_var")] 
  updated_data=list(updated_data_new1,updated_data_new2)
  rr=lasso_feature_selection_withoutcal(updated_data,ex_validation,timess)
  coeff=rr[[1]]
  cindex=rr[[2]]
  length_coef=rr[[3]]
  bs=rr[[4]]
  auc=rr[[5]]
  distance_train=ks.test(updated_data[[1]]$time,data$time)
  distance_test=ks.test(updated_data[[2]]$time,data$time)
  lambda=rr[[16]]
  npasses=rr[[17]]
  devratio=rr[[18]]
  cindex_train=rr[[19]]
  bs_train=rr[[20]]
  cindex_ex=rr[[21]]
  bs_ex=rr[[22]]
  auc_ex=rr[[23]]
  auc_ex_all=c(unlist(rr[[24]]),unlist(rr[[25]]),unlist(rr[[26]]),unlist(rr[[27]]),unlist(rr[[28]]),unlist(rr[[29]]),unlist(rr[[30]]),unlist(rr[[31]]),unlist(rr[[32]]),unlist(rr[[33]]))
  auc_te_all=c(unlist(rr[[6]]),unlist(rr[[7]]),unlist(rr[[8]]),unlist(rr[[9]]),unlist(rr[[10]]),unlist(rr[[11]]),unlist(rr[[12]]),unlist(rr[[13]]),unlist(rr[[14]]),unlist(rr[[15]]))
  # cal_train=rr[[34]]
  # cal_test=rr[[35]]
  # cal_ex=rr[[36]]
  # return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all,cal_train,cal_test,cal_ex))
  return(list(censoring_rate_train,coeff,cindex,length_coef,bs,auc,censoring_rate_test,distance_train,distance_test,lambda,npasses,devratio,cindex_train,bs_train,cindex_ex,bs_ex,auc_ex,auc_ex_all,auc_te_all))
},otherwise = NA)
```


# BRCA data
```{r}
current_data=read.csv("BRCA.csv")
current_data2=current_data
colnames(current_data2)[(dim(current_data2)[2]-2):dim(current_data2)[2]]=c("control_var","status","time")
current_data2$time=as.numeric(current_data2$time)
current_data2=current_data2[current_data2$time>0,]
current_data2=current_data2[!is.na(current_data2$time),]
dim(current_data)
dim(current_data2)
table(current_data2$control_var)
current_data2$control_var=ifelse(current_data2$control_var=="FEMALE",0,1) #female is group0 as the proportion control
set.seed(230720)
rownum=sample(nrow(current_data2),nrow(current_data2)*0.2,replace = FALSE)
ex_validation=current_data2[rownum,]
current_data2=current_data2[-rownum,]
dim(ex_validation)
dim(current_data2)
table(current_data2$status)
summary(current_data2$time)
#define the data with control_var to run the with control_var method
current_data3=current_data2
external_validation3=ex_validation
dim(current_data3)
dim(external_validation3)
#get datasets do not include gender to run other methods
current_data2=current_data2[,-which(colnames(current_data2)=="control_var")]
ex_validation=ex_validation[,-which(colnames(ex_validation)=="control_var")]
dim(ex_validation)
dim(current_data2)
```

run results
```{r eval=FALSE}
timess=seq(as.numeric(summary(current_data2$time)[2]),as.numeric(summary(current_data2$time)[5]),(as.numeric(summary(current_data2$time)[5])-as.numeric(summary(current_data2$time)[2]))/9)

#stability_selection_fun7(1,data=current_data3,prob=0.5,ex_validation=ex_validation,timess=timess)

# result1new=pbmcapply::pbmclapply(1:500, stability_selection_fun7,data=current_data3,prob=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
# result2new=pbmcapply::pbmclapply(1:500, stability_selection_fun7,data=current_data3,prob=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
# result3new=pbmcapply::pbmclapply(1:500, stability_selection_fun7,data=current_data3,prob=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
# save(result1new,result2new,result3new,file="acc_gender.RData")

#calibration error: Error in cut.default(pred_prob, quantile(pred_prob, seq(0, 1, 1/ngroup)),  : 
# 'breaks' are not unique
# this error is easy to fix but need their effort to fix, otherwise i need to overwrite their functions.


#with replacement without control
result1=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result2=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result3=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result4=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.4,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result5=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result6=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.6,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result7=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result8=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.8,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result9=pbmcapply::pbmclapply(1:500, stability_selection_fun6,data=current_data2,m_percentage=0.9,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result=pbmcapply::pbmclapply(1:500, stability_selection_fun1,data=current_data2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
save(result,result1,result2,result3,result4,result5,result6,result7,result8,result9,file="brca_r.RData")

#without replacement without control
result1=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result2=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result3=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result4=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.4,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result5=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result6=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.6,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result7=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result8=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.8,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result9=pbmcapply::pbmclapply(1:500, stability_selection_fun5,data=current_data2,m_percentage=0.9,ex_validation=ex_validation,timess=timess,mc.cores = 15)
save(result1,result2,result3,result4,result5,result6,result7,result8,result9,file="brca.RData")


#with replacement with control
result1=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result2=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result3=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result4=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.4,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result5=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result6=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.6,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result7=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result8=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.8,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result9=pbmcapply::pbmclapply(1:500, stability_selection_fun4,data=current_data2,m_percentage=0.9,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result=pbmcapply::pbmclapply(1:500, stability_selection_fun1,data=current_data2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
save(result,result1,result2,result3,result4,result5,result6,result7,result8,result9,file="brca_rc.RData")

#without replacement with control
result1=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result2=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result3=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result4=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.4,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result5=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result6=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.6,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result7=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result8=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.8,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result9=pbmcapply::pbmclapply(1:500, stability_selection_fun3,data=current_data2,m_percentage=0.9,ex_validation=ex_validation,timess=timess,mc.cores = 15)
save(result1,result2,result3,result4,result5,result6,result7,result8,result9,file="brca_c.RData")

# censoring rate
result1=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.1,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result2=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.2,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result3=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.3,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result4=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.4,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result5=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.5,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result6=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.6,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result7=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.7,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result8=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.8,ex_validation=ex_validation,timess=timess,mc.cores = 15)
result9=pbmcapply::pbmclapply(1:500, stability_selection_fun2,data=current_data2,prob=0.9,ex_validation=ex_validation,timess=timess,mc.cores = 15)
save(result1,result2,result3,result4,result5,result6,result7,result8,result9,file="brca_censoring.RData")


```

## show sampling percentage for sampling with and without replace techniques
```{r}
#check the with replacement percentage of unique observations compared with the without
check_percentage=function(data,m_percentage){
  set.seed(20230824)
  i=1
  updated_data1=moutofn_bootstrap_fun(data,i,m_percentage)
  updated_data2=moutofn_bootstrap_fun_wr(data,i,m_percentage)
  sample1_tr=dim(as.data.frame(updated_data1[[1]])%>% distinct())[1]
  sample1_te=dim(as.data.frame(updated_data1[[2]])%>% distinct())[1]
  sample2_tr=dim(as.data.frame(updated_data2[[1]])%>% distinct())[1]
  sample2_te=dim(as.data.frame(updated_data2[[2]])%>% distinct())[1]
  return(c(sample1_tr,sample1_te,sample2_tr,sample2_te))
}

plotdt=cbind.data.frame(c("0.1_tr_without","0.1_tr_with","0.2_tr_without","0.2_tr_with","0.3_tr_without","0.3_tr_with","0.4_tr_without","0.4_tr_with","0.5_tr_without","0.5_tr_with","0.6_tr_without","0.6_tr_with","0.7_tr_without","0.7_tr_with","0.8_tr_without","0.8_tr_with","0.9_tr_without","0.9_tr_with","100%_tr_without","100%_tr_with"),c(check_percentage(current_data2,0.1)[c(1,3)],check_percentage(current_data2,0.2)[c(1,3)],check_percentage(current_data2,0.3)[c(1,3)],check_percentage(current_data2,0.4)[c(1,3)],check_percentage(current_data2,0.5)[c(1,3)],check_percentage(current_data2,0.6)[c(1,3)],check_percentage(current_data2,0.7)[c(1,3)],check_percentage(current_data2,0.8)[c(1,3)],check_percentage(current_data2,0.9)[c(1,3)],check_percentage(current_data2,1)[c(1,3)]),c(rep(c("without","with"),10)))
colnames(plotdt)=c("sampling_technique_names","unique_observations","replacement_no_yes")
plotdt$sampling_technique_names=sapply(strsplit(plotdt$sampling_technique_names,"_"), '[', 1)
#reshape(plotdt, idvar = "sampling_technique_names", timevar = "replacement_no_yes", direction = "wide")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=unique_observations,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ylim(c(0,dim(current_data2)[1]))
gg
ggplot1=gg
#ggsave("sampling_percentage_train_ovarian.pdf",gg,width = 8,height = 5)
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=unique_observations,color=replacement_no_yes,group=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ylim(c(0,dim(current_data2)[1]))
gg
ggplot2=gg
#ggsave("sampling_percentage_train_ovarian2.pdf",gg,width = 8,height = 5)

plotdt=cbind.data.frame(c("0.1_te_without","0.1_te_with","0.2_te_without","0.2_te_with","0.3_te_without","0.3_te_with","0.4_te_without","0.4_te_with","0.5_te_without","0.5_te_with","0.6_te_without","0.6_te_with","0.7_te_without","0.7_te_with","0.8_te_without","0.8_te_with","0.9_te_without","0.9_te_with","100%_te_without","100%_te_with"),c(check_percentage(current_data2,0.1)[c(2,4)],check_percentage(current_data2,0.2)[c(2,4)],check_percentage(current_data2,0.3)[c(2,4)],check_percentage(current_data2,0.4)[c(2,4)],check_percentage(current_data2,0.5)[c(2,4)],check_percentage(current_data2,0.6)[c(2,4)],check_percentage(current_data2,0.7)[c(2,4)],check_percentage(current_data2,0.8)[c(2,4)],check_percentage(current_data2,0.9)[c(2,4)],check_percentage(current_data2,1)[c(2,4)]),c(rep(c("without","with"),10)))
colnames(plotdt)=c("sampling_technique_names","unique_observations","replacement_no_yes")
plotdt$sampling_technique_names=sapply(strsplit(plotdt$sampling_technique_names,"_"), '[', 1)
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=unique_observations,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ylim(c(0,dim(current_data2)[1]))
gg
#ggsave("sampling_percentage_test_ovarian.pdf",gg,width = 8,height = 5)
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=unique_observations,color=replacement_no_yes,group=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ylim(c(0,dim(current_data2)[1]))+geom_line()
gg
#ggsave("sampling_percentage_test_ovarian2.pdf",gg,width = 8,height = 5)


```


## with replacement without control
```{r}
load("brca_r.RData")
#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

#result_table=get_table(result)[[1]]
result1_table=get_table(result1)[[1]]
result2_table=get_table(result2)[[1]]
result3_table=get_table(result3)[[1]]
result4_table=get_table(result4)[[1]]
result5_table=get_table(result5)[[1]]
result6_table=get_table(result6)[[1]]
result7_table=get_table(result7)[[1]]
result8_table=get_table(result8)[[1]]
result9_table=get_table(result9)[[1]]


other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

heatmap_data=data.frame(nrow=9*18,ncol=18)
heatmap_data[1:162,1]=rep(c("m0.1r","m0.2r","m0.3r","m0.4r","m0.5r","m0.6r","m0.7r","m0.8r","m0.9r"),each=18)
heatmap_data[1:162,2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),9)
heatmap_data[1:162,3]=c(other_table(result1,current_data2),other_table(result2,current_data2),other_table(result3,current_data2),other_table(result4,current_data2),other_table(result5,current_data2),other_table(result6,current_data2),other_table(result7,current_data2),other_table(result8,current_data2),other_table(result9,current_data2))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1r","m0.2r","m0.3r","m0.4r","m0.5r","m0.6r","m0.7r","m0.8r","m0.9r")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1r","m0.2r","m0.3r","m0.4r","m0.5r","m0.6r","m0.7r","m0.8r","m0.9r")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1r","m0.2r","m0.3r","m0.4r","m0.5r","m0.6r","m0.7r","m0.8r","m0.9r")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg

r_result=heatmap_data
```

## without replacement without control
```{r}
load("brca.RData")
#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

#result_table=get_table(result)[[1]]
result1_table=get_table(result1)[[1]]
result2_table=get_table(result2)[[1]]
result3_table=get_table(result3)[[1]]
result4_table=get_table(result4)[[1]]
result5_table=get_table(result5)[[1]]
result6_table=get_table(result6)[[1]]
result7_table=get_table(result7)[[1]]
result8_table=get_table(result8)[[1]]
result9_table=get_table(result9)[[1]]


other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

heatmap_data=data.frame(nrow=9*18,ncol=18)
heatmap_data[1:162,1]=rep(c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9"),each=18)
heatmap_data[1:162,2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),9)
heatmap_data[1:162,3]=c(other_table(result1,current_data2),other_table(result2,current_data2),other_table(result3,current_data2),other_table(result4,current_data2),other_table(result5,current_data2),other_table(result6,current_data2),other_table(result7,current_data2),other_table(result8,current_data2),other_table(result9,current_data2))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg

result=heatmap_data
```

what in my mind
```{r}

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="cindex","value"],r_result[r_result$metric=="cindex","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","C_index","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=C_index,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=C_index,color=replacement_no_yes))
# dt1=plotdt[plotdt$replacement_no_yes=="without",]
# dt2=plotdt[plotdt$replacement_no_yes=="with",]
# ggplot() +
#   geom_point(data = dt1, aes(x = sampling_technique_names, y = C_index, color = replacement_no_yes)) +
#   geom_point(data = dt2, aes(x = sampling_technique_names, y = C_index, color = replacement_no_yes)) +
#   geom_curve()  +
#   labs(title = "Connecting two groups of points with curves") +
#   theme_minimal()
ggplot3=gg


plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="cindex_train","value"],r_result[r_result$metric=="cindex_train","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","cindex_train","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=cindex_train,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=cindex_train,color=replacement_no_yes))
ggplot4=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="cindex_ex","value"],r_result[r_result$metric=="cindex_ex","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","cindex_ex","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=cindex_ex,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=cindex_ex,color=replacement_no_yes))
ggplot5=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="brier_score","value"],r_result[r_result$metric=="brier_score","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","brier_score","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=brier_score,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=brier_score,color=replacement_no_yes))
ggplot6=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="brier_score_train","value"],r_result[r_result$metric=="brier_score_train","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","brier_score_train","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=brier_score_train,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=brier_score_train,color=replacement_no_yes))
ggplot7=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="brier_score_ex","value"],r_result[r_result$metric=="brier_score_ex","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","brier_score_ex","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=brier_score_ex,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=brier_score_ex,color=replacement_no_yes))
ggplot8=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="censoring_rate","value"],r_result[r_result$metric=="censoring_rate","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","censoring_rate","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=censoring_rate,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=censoring_rate,color=replacement_no_yes))
ggplot9=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="censoring_rate_test","value"],r_result[r_result$metric=="censoring_rate_test","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","censoring_rate_test","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=censoring_rate_test,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=censoring_rate_test,color=replacement_no_yes))
ggplot10=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="distance_stat","value"],r_result[r_result$metric=="distance_stat","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","distance_stat","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=distance_stat,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=distance_stat,color=replacement_no_yes))
ggplot11=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="distance_stat_test","value"],r_result[r_result$metric=="distance_stat_test","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","distance_stat_test","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=distance_stat_test,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=distance_stat_test,color=replacement_no_yes))
ggplot12=gg

ggarrange(ggplot1,ggplot2,ggplot3,ggplot4,ggplot5,ggplot6,ggplot7,ggplot8,ggplot9,ggplot10,ggplot11,ggplot12,nrow=4,ncol = 3)
```


## with replacement with control
```{r}
load("brca_rc.RData")
#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

#result_table=get_table(result)[[1]]
result1_table=get_table(result1)[[1]]
result2_table=get_table(result2)[[1]]
result3_table=get_table(result3)[[1]]
result4_table=get_table(result4)[[1]]
result5_table=get_table(result5)[[1]]
result6_table=get_table(result6)[[1]]
result7_table=get_table(result7)[[1]]
result8_table=get_table(result8)[[1]]
result9_table=get_table(result9)[[1]]


other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

heatmap_data=data.frame(nrow=9*18,ncol=18)
heatmap_data[1:162,1]=rep(c("m0.1r","m0.2r","m0.3r","m0.4r","m0.5r","m0.6r","m0.7r","m0.8r","m0.9r"),each=18)
heatmap_data[1:162,2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),9)
heatmap_data[1:162,3]=c(other_table(result1,current_data2),other_table(result2,current_data2),other_table(result3,current_data2),other_table(result4,current_data2),other_table(result5,current_data2),other_table(result6,current_data2),other_table(result7,current_data2),other_table(result8,current_data2),other_table(result9,current_data2))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1r","m0.2r","m0.3r","m0.4r","m0.5r","m0.6r","m0.7r","m0.8r","m0.9r")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1r","m0.2r","m0.3r","m0.4r","m0.5r","m0.6r","m0.7r","m0.8r","m0.9r")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1r","m0.2r","m0.3r","m0.4r","m0.5r","m0.6r","m0.7r","m0.8r","m0.9r")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg

r_result=heatmap_data
```

## without replacement with control
```{r}
load("brca_c.RData")
#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

#result_table=get_table(result)[[1]]
result1_table=get_table(result1)[[1]]
result2_table=get_table(result2)[[1]]
result3_table=get_table(result3)[[1]]
result4_table=get_table(result4)[[1]]
result5_table=get_table(result5)[[1]]
result6_table=get_table(result6)[[1]]
result7_table=get_table(result7)[[1]]
result8_table=get_table(result8)[[1]]
result9_table=get_table(result9)[[1]]


other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

heatmap_data=data.frame(nrow=9*18,ncol=18)
heatmap_data[1:162,1]=rep(c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9"),each=18)
heatmap_data[1:162,2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),9)
heatmap_data[1:162,3]=c(other_table(result1,current_data2),other_table(result2,current_data2),other_table(result3,current_data2),other_table(result4,current_data2),other_table(result5,current_data2),other_table(result6,current_data2),other_table(result7,current_data2),other_table(result8,current_data2),other_table(result9,current_data2))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg

result=heatmap_data
```

what in my mind
```{r}

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="cindex","value"],r_result[r_result$metric=="cindex","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","C_index","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=C_index,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=C_index,color=replacement_no_yes))
# dt1=plotdt[plotdt$replacement_no_yes=="without",]
# dt2=plotdt[plotdt$replacement_no_yes=="with",]
# ggplot() +
#   geom_point(data = dt1, aes(x = sampling_technique_names, y = C_index, color = replacement_no_yes)) +
#   geom_point(data = dt2, aes(x = sampling_technique_names, y = C_index, color = replacement_no_yes)) +
#   geom_curve()  +
#   labs(title = "Connecting two groups of points with curves") +
#   theme_minimal()
ggplot3=gg


plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="cindex_train","value"],r_result[r_result$metric=="cindex_train","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","cindex_train","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=cindex_train,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=cindex_train,color=replacement_no_yes))
ggplot4=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="cindex_ex","value"],r_result[r_result$metric=="cindex_ex","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","cindex_ex","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=cindex_ex,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=cindex_ex,color=replacement_no_yes))
ggplot5=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="brier_score","value"],r_result[r_result$metric=="brier_score","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","brier_score","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=brier_score,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=brier_score,color=replacement_no_yes))
ggplot6=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="brier_score_train","value"],r_result[r_result$metric=="brier_score_train","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","brier_score_train","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=brier_score_train,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=brier_score_train,color=replacement_no_yes))
ggplot7=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="brier_score_ex","value"],r_result[r_result$metric=="brier_score_ex","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","brier_score_ex","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=brier_score_ex,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=brier_score_ex,color=replacement_no_yes))
ggplot8=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="censoring_rate","value"],r_result[r_result$metric=="censoring_rate","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","censoring_rate","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=censoring_rate,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=censoring_rate,color=replacement_no_yes))
ggplot9=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="censoring_rate_test","value"],r_result[r_result$metric=="censoring_rate_test","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","censoring_rate_test","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=censoring_rate_test,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=censoring_rate_test,color=replacement_no_yes))
ggplot10=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="distance_stat","value"],r_result[r_result$metric=="distance_stat","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","distance_stat","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=distance_stat,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=distance_stat,color=replacement_no_yes))
ggplot11=gg

plotdt=cbind.data.frame(c(c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9"),c("0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8","0.9")),c(result[result$metric=="distance_stat_test","value"],r_result[r_result$metric=="distance_stat_test","value"]),c(rep("without",9),rep("with",9)))
colnames(plotdt)=c("sampling_technique_names","distance_stat_test","replacement_no_yes")
gg=ggplot(plotdt,aes(x=sampling_technique_names,y=distance_stat_test,color=replacement_no_yes))+geom_point()+ theme_bw()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+geom_line(aes(x=sampling_technique_names,y=distance_stat_test,color=replacement_no_yes))
ggplot12=gg

ggarrange(ggplot1,ggplot2,ggplot3,ggplot4,ggplot5,ggplot6,ggplot7,ggplot8,ggplot9,ggplot10,ggplot11,ggplot12,nrow=4,ncol = 3)
```


copied codes from code 12 file.
```{r}
#generate the dataset used to plot the heatmap, the rows are the datasets and the columns are metrics: censoring rate, cindex, number of variables selected
gg_heatmap_data=heatmap_data
gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]=gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]/max(gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"])
ggheatmap <-ggplot(gg_heatmap_data, aes(case, metric, fill= value)) + 
 geom_tile(color = "grey")+scale_fill_gradientn(limits = c(0,1),colours = c("#2166AC", "#67A9CF" ,"#D1E5F0", "#FFFFFF","#FDDBC7", "#EF8A62", "#B2182B"))+ theme(aspect.ratio = 1, text = element_text(size = 5), legend.position = "bottom") + labs(y= 'Metrics', x = "Cases", fill = 'Values')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))+
  geom_text(aes(label = round(value,3)), color = "black", size = 4)
ggheatmap

#get all seperate scatter plots
plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
ggplot(plotdt_wide2,aes(x=censoring_rate,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with distance_stat")

plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat_test","censoring_rate_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
ggplot(plotdt_wide2,aes(x=censoring_rate_test,y=distance_stat_test,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate test with distance_stat test")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=censoring_rate,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("distance_stat with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
gg=ggplot(plotdt_wide2,aes(x=num_variables,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with num_variables")+theme_bw()+theme(aspect.ratio = 1)
gg
#ggsave("lasso_ovarian_checkwith_num_var.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
ggplot(plotdt_wide2,aes(x=cindex_train,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with cindex_train")

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_external.pdf",gg)

#fit model using the entire data on lasso cox and add into the external performance
tr_matrix=data.matrix(current_data2[,!names(current_data2)%in% c("time","status")])
te_matrix=data.matrix(ex_validation[,!names(ex_validation)%in% c("time","status")])
tr_st=current_data2$time
tr_y=current_data2$status
te_st=ex_validation$time
te_y=ex_validation$status
  fit <- fit_lasso(tr_matrix, Surv(tr_st, tr_y), nfolds = 5, rule = "lambda.min")
  tr_times=current_data2$time
  te_times=ex_validation$time
  pred_te_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = te_matrix,pred.at=te_times)
  pred_tr_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = tr_matrix,pred.at=tr_times)
  pred_te=c()
  for(i in 1:nrow(pred_te_matrix)){
    pred_te[i]=pred_te_matrix[i,][which(colnames(pred_te_matrix)==te_times[i])[1]]
  }
  pred_tr=c()
  for(i in 1:nrow(pred_tr_matrix)){
    pred_tr[i]=pred_tr_matrix[i,][which(colnames(pred_tr_matrix)==tr_times[i])[1]]
  }
  harrelC1 <- rcorr.cens(-pred_te,with(ex_validation,Surv(time,status)))
  cindex_test<-harrelC1["C Index"]
  # #calculate brier score:currently cannot be calculated if only have training data
  times=median(current_data2$time)
  Surv.rsp <- Surv(current_data2$time,current_data2$status)
  Surv.rsp.new <- Surv(ex_validation$time,ex_validation$status)
  lp<-pred_tr
  lp.new=pred_te
  bs_test <- predErr(Surv.rsp,Surv.rsp.new,lp,lp.new, time = times)$error
 plotdt_wide2[dim(plotdt_wide2)[1]+1,] =c(round(cindex_test,3),round(bs_test,3),"raw")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_external_raw.pdf",gg)
```


```{r}
#feature selection
#pure intersection: not many
all_variables=list(result2_table$name[which(result2_table$freq>=1)],result3_table$name[which(result3_table$freq>=1)],result4_table$name[which(result4_table$freq>=1)],result5_table$name[which(result5_table$freq>=1)],result6_table$name[which(result6_table$freq>=1)],result7_table$name[which(result7_table$freq>=1)],result8_table$name[which(result8_table$freq>=1)],result11_table$name[which(result11_table$freq>=1)],result12_table$name[which(result12_table$freq>=1)],result13_table$name[which(result13_table$freq>=1)],result14_table$name[which(result14_table$freq>=1)],result15_table$name[which(result15_table$freq>=1)],result16_table$name[which(result16_table$freq>=1)],result17_table$name[which(result17_table$freq>=1)],result18_table$name[which(result18_table$freq>=1)])

intersection_variables=Reduce(intersect,all_variables)
intersection_variables

#selected time more than 0.75, freq more than 1.
union_vector=unique(c(result2_table$name[which(result2_table$freq>1)],result3_table$name[which(result3_table$freq>1)],result4_table$name[which(result4_table$freq>1)],result5_table$name[which(result5_table$freq>1)],result6_table$name[which(result6_table$freq>1)],result7_table$name[which(result7_table$freq>1)],result8_table$name[which(result8_table$freq>1)],result11_table$name[which(result11_table$freq>1)],result12_table$name[which(result12_table$freq>1)],result13_table$name[which(result13_table$freq>1)],result14_table$name[which(result14_table$freq>1)],result15_table$name[which(result15_table$freq>1)],result16_table$name[which(result16_table$freq>1)],result17_table$name[which(result17_table$freq>1)],result18_table$name[which(result18_table$freq>1)]))


selected_variables=data.frame(matrix(nrow = length(union_vector),ncol = length(all_variables)))
for(i in 1:length(all_variables)){
  for(j in 1:length(union_vector)){
    selected_variables[j,i]=ifelse(union_vector[j]%in%all_variables[[i]],1,0)
  }
}
final_selection=union_vector[which(rowSums(selected_variables)>dim(selected_variables)[2]*(1/2))]
length(final_selection) 
#the number of selected variables are determined by the average of the best performed samples/the bootstrap one
rearranged=union_vector[c(order(rowSums(selected_variables)))]
lasso_variable=final_selection

#add summarise stat
success_rate_fun=function(result){
success_rate=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){success_rate[i]=0}else{success_rate[i]=1}
}
return(sum(success_rate)/length(result))}

lambda_vec_fun=function(result){
lambda_vec=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){lambda_vec[i]=0}else{lambda_vec[i]=result[[i]][[16]]}
}
return(lambda_vec)}

all_train_cindex_fun=function(result){
  all_train_cindex=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cindex[i]=0}else{all_train_cindex[i]=result[[i]][[13]]}
}
return(all_train_cindex)}

all_train_bs_fun=function(result){
  all_train_bs=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_bs[i]=0}else{all_train_bs[i]=result[[i]][[14]]}
}
return(all_train_bs)}

all_train_distance_fun=function(result){
  all_train_distance=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_distance[i]=0}else{all_train_distance[i]=result[[i]][[8]]$statistic}
}
return(all_train_distance)}

all_train_cr_fun=function(result){
  all_train_cr=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cr[i]=0}else{all_train_cr[i]=result[[i]][[1]]}
}
return(all_train_cr)}

#in test
all_test_cindex_fun=function(result){
  all_test_cindex=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_test_cindex[i]=0}else{all_test_cindex[i]=result[[i]][[3]]}
}
return(all_test_cindex)}

all_test_bs_fun=function(result){
  all_test_bs=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_test_bs[i]=0}else{all_test_bs[i]=result[[i]][[5]]}
}
return(all_test_bs)}

all_test_distance_fun=function(result){
  all_test_distance=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_test_distance[i]=0}else{all_test_distance[i]=result[[i]][[9]]$statistic}
}
return(all_test_distance)}

all_test_cr_fun=function(result){
  all_test_cr=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_test_cr[i]=0}else{all_test_cr[i]=result[[i]][[7]]}
}
return(all_test_cr)}

#testing
current=heatmap_data[heatmap_data$metric%in%c("cindex","auc","brier_score"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")

lasso_ave=current_wide2$cindex+current_wide2$auc+1-current_wide2$brier_score

dd=cbind.data.frame(rank(-lasso_ave),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3=dd[dd$order%in%c(1,2,3),2]
lasso_cindex=current_wide2$cindex
lasso_auc=current_wide2$auc
lasso_bs=current_wide2$brier_score
lasso_success_rate=c(success_rate_fun(result1),success_rate_fun(result2),success_rate_fun(result3),success_rate_fun(result4),success_rate_fun(result5),success_rate_fun(result6),success_rate_fun(result7),success_rate_fun(result8),success_rate_fun(result9),success_rate_fun(result11),success_rate_fun(result12),success_rate_fun(result13),success_rate_fun(result14),success_rate_fun(result15),success_rate_fun(result16),success_rate_fun(result17),success_rate_fun(result18),success_rate_fun(result19))

lasso_lambda_all=c(lambda_vec_fun(result1),lambda_vec_fun(result2),lambda_vec_fun(result3),lambda_vec_fun(result4),lambda_vec_fun(result5),lambda_vec_fun(result6),lambda_vec_fun(result7),lambda_vec_fun(result8),lambda_vec_fun(result9),lambda_vec_fun(result11),lambda_vec_fun(result12),lambda_vec_fun(result13),lambda_vec_fun(result14),lambda_vec_fun(result15),lambda_vec_fun(result16),lambda_vec_fun(result17),lambda_vec_fun(result18),lambda_vec_fun(result19))


#external
current=heatmap_data[heatmap_data$metric%in%c("cindex_ex","auc_ex","brier_score_ex"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
lasso_ave_ex=current_wide2$cindex_ex+current_wide2$auc_ex+1-current_wide2$brier_score_ex
lasso_cindex_ex=current_wide2$cindex_ex
lasso_auc_ex=current_wide2$auc_ex
lasso_bs_ex=current_wide2$brier_score_ex

dd=cbind.data.frame(rank(-lasso_ave_ex),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3_ex=dd[dd$order%in%c(1,2,3),2]

#training
current=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
lasso_ave_train=current_wide2$cindex_train+1-current_wide2$brier_score_train
lasso_cindex_train=current_wide2$cindex_train
lasso_bs_train=current_wide2$brier_score_train

dd=cbind.data.frame(rank(-lasso_ave_train),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3_train=dd[dd$order%in%c(1,2,3),2]

#lambda with success rate
lasso_lambda_mean=c(mean(lambda_vec_fun(result1)),mean(lambda_vec_fun(result2)),mean(lambda_vec_fun(result3)),mean(lambda_vec_fun(result4)),mean(lambda_vec_fun(result5)),mean(lambda_vec_fun(result6)),mean(lambda_vec_fun(result7)),mean(lambda_vec_fun(result8)),mean(lambda_vec_fun(result9)),mean(lambda_vec_fun(result11)),mean(lambda_vec_fun(result12)),mean(lambda_vec_fun(result13)),mean(lambda_vec_fun(result14)),mean(lambda_vec_fun(result15)),mean(lambda_vec_fun(result16)),mean(lambda_vec_fun(result17)),mean(lambda_vec_fun(result18)),mean(lambda_vec_fun(result19)))
dd=cbind.data.frame(lasso_success_rate,lasso_lambda_mean,lasso_ave)
dd$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
ggplot(dd,aes(x=lasso_lambda_mean,y=lasso_success_rate,label=label,color=lasso_ave))+geom_point()+geom_text_repel(size=4)+ggtitle("Lambda versus success rate with performance (ave test)")
#train performance with success rate
dd=cbind.data.frame(lasso_success_rate,lasso_lambda_mean,lasso_ave_train)
dd$label=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr")
ggplot(dd,aes(x=lasso_ave_train,y=lasso_success_rate,label=label,color=lasso_lambda_mean))+geom_point()+geom_text_repel(size=4)+ggtitle("Train performance versus success rate with mean lambda")+theme_bw()
gg=ggplot(dd,aes(x=lasso_ave_train,y=lasso_success_rate,label=label,color=lasso_lambda_mean))+geom_point()+geom_text_repel(size=4)+ggtitle("Train performance versus success rate with mean lambda")+theme_bw()
#ggsave("lasso_ovarian_with_trainaverage.pdf",gg)
#train performance with vairability within one method
lasso_train_cindex_all=c(all_train_cindex_fun(result1),all_train_cindex_fun(result2),all_train_cindex_fun(result3),all_train_cindex_fun(result4),all_train_cindex_fun(result5),all_train_cindex_fun(result6),all_train_cindex_fun(result7),all_train_cindex_fun(result8),all_train_cindex_fun(result9),all_train_cindex_fun(result11),all_train_cindex_fun(result12),all_train_cindex_fun(result13),all_train_cindex_fun(result14),all_train_cindex_fun(result15),all_train_cindex_fun(result16),all_train_cindex_fun(result17),all_train_cindex_fun(result18),all_train_cindex_fun(result19))
lasso_train_distance_all=c(all_train_distance_fun(result1),all_train_distance_fun(result2),all_train_distance_fun(result3),all_train_distance_fun(result4),all_train_distance_fun(result5),all_train_distance_fun(result6),all_train_distance_fun(result7),all_train_distance_fun(result8),all_train_distance_fun(result9),all_train_distance_fun(result11),all_train_distance_fun(result12),all_train_distance_fun(result13),all_train_distance_fun(result14),all_train_distance_fun(result15),all_train_distance_fun(result16),all_train_distance_fun(result17),all_train_distance_fun(result18),all_train_distance_fun(result19))
lasso_train_cr_all=c(all_train_cr_fun(result1),all_train_cr_fun(result2),all_train_cr_fun(result3),all_train_cr_fun(result4),all_train_cr_fun(result5),all_train_cr_fun(result6),all_train_cr_fun(result7),all_train_cr_fun(result8),all_train_cr_fun(result9),all_train_cr_fun(result11),all_train_cr_fun(result12),all_train_cr_fun(result13),all_train_cr_fun(result14),all_train_cr_fun(result15),all_train_cr_fun(result16),all_train_cr_fun(result17),all_train_cr_fun(result18),all_train_cr_fun(result19))
lasso_train_bs_all=c(all_train_bs_fun(result1),all_train_bs_fun(result2),all_train_bs_fun(result3),all_train_bs_fun(result4),all_train_bs_fun(result5),all_train_bs_fun(result6),all_train_bs_fun(result7),all_train_bs_fun(result8),all_train_bs_fun(result9),all_train_bs_fun(result11),all_train_bs_fun(result12),all_train_bs_fun(result13),all_train_bs_fun(result14),all_train_bs_fun(result15),all_train_bs_fun(result16),all_train_bs_fun(result17),all_train_bs_fun(result18),all_train_bs_fun(result19))

#in test
lasso_test_cindex_all=c(all_test_cindex_fun(result1),all_test_cindex_fun(result2),all_test_cindex_fun(result3),all_test_cindex_fun(result4),all_test_cindex_fun(result5),all_test_cindex_fun(result6),all_test_cindex_fun(result7),all_test_cindex_fun(result8),all_test_cindex_fun(result9),all_test_cindex_fun(result11),all_test_cindex_fun(result12),all_test_cindex_fun(result13),all_test_cindex_fun(result14),all_test_cindex_fun(result15),all_test_cindex_fun(result16),all_test_cindex_fun(result17),all_test_cindex_fun(result18),all_test_cindex_fun(result19))
lasso_test_distance_all=c(all_test_distance_fun(result1),all_test_distance_fun(result2),all_test_distance_fun(result3),all_test_distance_fun(result4),all_test_distance_fun(result5),all_test_distance_fun(result6),all_test_distance_fun(result7),all_test_distance_fun(result8),all_test_distance_fun(result9),all_test_distance_fun(result11),all_test_distance_fun(result12),all_test_distance_fun(result13),all_test_distance_fun(result14),all_test_distance_fun(result15),all_test_distance_fun(result16),all_test_distance_fun(result17),all_test_distance_fun(result18),all_test_distance_fun(result19))
lasso_test_cr_all=c(all_test_cr_fun(result1),all_test_cr_fun(result2),all_test_cr_fun(result3),all_test_cr_fun(result4),all_test_cr_fun(result5),all_test_cr_fun(result6),all_test_cr_fun(result7),all_test_cr_fun(result8),all_test_cr_fun(result9),all_test_cr_fun(result11),all_test_cr_fun(result12),all_test_cr_fun(result13),all_test_cr_fun(result14),all_test_cr_fun(result15),all_test_cr_fun(result16),all_test_cr_fun(result17),all_test_cr_fun(result18),all_test_cr_fun(result19))
lasso_test_bs_all=c(all_test_bs_fun(result1),all_test_bs_fun(result2),all_test_bs_fun(result3),all_test_bs_fun(result4),all_test_bs_fun(result5),all_test_bs_fun(result6),all_test_bs_fun(result7),all_test_bs_fun(result8),all_test_bs_fun(result9),all_test_bs_fun(result11),all_test_bs_fun(result12),all_test_bs_fun(result13),all_test_bs_fun(result14),all_test_bs_fun(result15),all_test_bs_fun(result16),all_test_bs_fun(result17),all_test_bs_fun(result18),all_test_bs_fun(result19))
```


```{r fig.height=30,fig.width=30}
dd=cbind.data.frame(lasso_test_cindex_all,lasso_test_distance_all,lasso_lambda_all,lasso_test_cr_all,lasso_test_bs_all)
dd$label=rep(c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr"),each=500)

dd$label=factor(rep(c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr"),each=500),levels=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr"))
dim(dd)
dd=dd[-which(dd$lasso_test_cindex_all==0),]
dim(dd)
dd=dd[which(dd$label%in%c("m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")),]
dim(dd)
ggplot(dd,aes(x=lasso_test_cindex_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all))+geom_point()+ggtitle("train cindex versus all aspects")+facet_wrap(~label,ncol=3)+theme_bw()
ggplot(dd,aes(x=lasso_test_bs_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all))+geom_point()+ggtitle("train bs versus all aspects")+facet_wrap(~label,ncol=3)+theme_bw()
gg=ggplot(dd,aes(x=lasso_test_cindex_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all))+geom_point()+ggtitle("train cindex versus all aspects")+facet_wrap(~label,ncol=3)+theme_bw()
#ggsave("lasso_ovarian_checkwith_test_cindexvar.pdf",gg,height=10,width=10)
gg=ggplot(dd,aes(x=lasso_test_bs_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all))+geom_point()+ggtitle("train bs versus all aspects")+facet_wrap(~label,ncol=3)+theme_bw()
#ggsave("lasso_ovarian_checkwith_test_bsvar.pdf",gg,height=10,width=10)
dd$m=c(rep("0.3",dim(dd[dd$label=="m0.3",])[1]),rep("0.5",dim(dd[dd$label=="m0.5",])[1]),rep("0.7",dim(dd[dd$label=="m0.7",])[1]),rep("0.3",dim(dd[dd$label=="m0.3wr",])[1]),rep("0.5",dim(dd[dd$label=="m0.5wr",])[1]),rep("0.7",dim(dd[dd$label=="m0.7wr",])[1]))
dd$group=c(rep("with replacement",dim(dd[dd$label=="m0.3",])[1]+dim(dd[dd$label=="m0.5",])[1]+dim(dd[dd$label=="m0.7",])[1]),rep("without replacement",dim(dd[dd$label=="m0.3wr",])[1]+dim(dd[dd$label=="m0.5wr",])[1]+dim(dd[dd$label=="m0.7wr",])[1]))
gg=ggplot(dd,aes(x=lasso_test_cindex_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all,shape=group))+geom_point()+ggtitle("test cindex versus all aspects")+facet_wrap(~m,ncol=3)+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_test_cindexvar2.pdf",gg,height=8,width=10)
gg=ggplot(dd,aes(x=lasso_test_bs_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all/100,shape=group))+geom_point(aes(size=lasso_test_cr_all/100))+ggtitle("test bs versus all aspects")+facet_wrap(~m,ncol=3)+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_test_bsvar.pdf",gg,height=5,width=10)
gg=ggplot(dd,aes(x=lasso_test_bs_all,y=lasso_test_distance_all,color=lasso_test_cr_all,shape=group))+geom_point()+ggtitle("test bs versus all aspects")+facet_wrap(~m,ncol=3)+theme_bw()
gg
#ggsave("lasso_ovarian_checkwith_test_bsvar3.pdf",gg,height=5,width=10)
```

add in the test
```{r}
m1<-wilcox.test( dd[dd$label=="m0.3","lasso_test_cindex_all"],dd[dd$label=="m0.3wr","lasso_test_cindex_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)

m1<-wilcox.test( dd[dd$label=="m0.5","lasso_test_cindex_all"],dd[dd$label=="m0.5wr","lasso_test_cindex_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)

m1<-wilcox.test( dd[dd$label=="m0.7","lasso_test_cindex_all"],dd[dd$label=="m0.7wr","lasso_test_cindex_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)


m1<-wilcox.test( dd[dd$label=="m0.3","lasso_test_bs_all"],dd[dd$label=="m0.3wr","lasso_test_bs_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)

m1<-wilcox.test( dd[dd$label=="m0.5","lasso_test_bs_all"],dd[dd$label=="m0.5wr","lasso_test_bs_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)

m1<-wilcox.test( dd[dd$label=="m0.7","lasso_test_bs_all"],dd[dd$label=="m0.7wr","lasso_test_bs_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)
```

add in the bias-var trade-off
```{r}
#calculate the mean and sd
mean(dd[dd$label=="m0.3","lasso_test_cindex_all"])
sd(dd[dd$label=="m0.3","lasso_test_cindex_all"])
mean(dd[dd$label=="m0.5","lasso_test_cindex_all"])
sd(dd[dd$label=="m0.5","lasso_test_cindex_all"])
mean(dd[dd$label=="m0.7","lasso_test_cindex_all"])
sd(dd[dd$label=="m0.7","lasso_test_cindex_all"])
mean(dd[dd$label=="m0.3wr","lasso_test_cindex_all"])
sd(dd[dd$label=="m0.3wr","lasso_test_cindex_all"])
mean(dd[dd$label=="m0.5wr","lasso_test_cindex_all"])
sd(dd[dd$label=="m0.5wr","lasso_test_cindex_all"])
mean(dd[dd$label=="m0.7wr","lasso_test_cindex_all"])
sd(dd[dd$label=="m0.7wr","lasso_test_cindex_all"])

mean(dd[dd$label=="m0.3","lasso_test_bs_all"])
sd(dd[dd$label=="m0.3","lasso_test_bs_all"])
mean(dd[dd$label=="m0.5","lasso_test_bs_all"])
sd(dd[dd$label=="m0.5","lasso_test_bs_all"])
mean(dd[dd$label=="m0.7","lasso_test_bs_all"])
sd(dd[dd$label=="m0.7","lasso_test_bs_all"])
mean(dd[dd$label=="m0.3wr","lasso_test_bs_all"])
sd(dd[dd$label=="m0.3wr","lasso_test_bs_all"])
mean(dd[dd$label=="m0.5wr","lasso_test_bs_all"])
sd(dd[dd$label=="m0.5wr","lasso_test_bs_all"])
mean(dd[dd$label=="m0.7wr","lasso_test_bs_all"])
sd(dd[dd$label=="m0.7wr","lasso_test_bs_all"])
```


check results in train
```{r fig.height=30,fig.width=30}
dd=cbind.data.frame(lasso_train_cindex_all,lasso_train_distance_all,lasso_lambda_all,lasso_train_cr_all,lasso_train_bs_all)
dd$label=rep(c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr"),each=500)

dd$label=factor(rep(c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr"),each=500),levels=c("m0.1","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.9","m0.1wr","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr"))
dim(dd)
dd=dd[-which(dd$lasso_train_cindex_all==0),]
dim(dd)
dd=dd[which(dd$label%in%c("m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")),]
dim(dd)
# ggplot(dd,aes(x=lasso_test_cindex_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all))+geom_point()+ggtitle("train cindex versus all aspects")+facet_wrap(~label,ncol=3)+theme_bw()
# ggplot(dd,aes(x=lasso_test_bs_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all))+geom_point()+ggtitle("train bs versus all aspects")+facet_wrap(~label,ncol=3)+theme_bw()
# gg=ggplot(dd,aes(x=lasso_test_cindex_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all))+geom_point()+ggtitle("train cindex versus all aspects")+facet_wrap(~label,ncol=3)+theme_bw()
# #ggsave("lasso_ovarian_checkwith_test_cindexvar.pdf",gg,height=10,width=10)
# gg=ggplot(dd,aes(x=lasso_test_bs_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all))+geom_point()+ggtitle("train bs versus all aspects")+facet_wrap(~label,ncol=3)+theme_bw()
# #ggsave("lasso_ovarian_checkwith_test_bsvar.pdf",gg,height=10,width=10)
dd$m=c(rep("0.3",dim(dd[dd$label=="m0.3",])[1]),rep("0.5",dim(dd[dd$label=="m0.5",])[1]),rep("0.7",dim(dd[dd$label=="m0.7",])[1]),rep("0.3",dim(dd[dd$label=="m0.3wr",])[1]),rep("0.5",dim(dd[dd$label=="m0.5wr",])[1]),rep("0.7",dim(dd[dd$label=="m0.7wr",])[1]))
dd$group=c(rep("with replacement",dim(dd[dd$label=="m0.3",])[1]+dim(dd[dd$label=="m0.5",])[1]+dim(dd[dd$label=="m0.7",])[1]),rep("without replacement",dim(dd[dd$label=="m0.3wr",])[1]+dim(dd[dd$label=="m0.5wr",])[1]+dim(dd[dd$label=="m0.7wr",])[1]))
# gg=ggplot(dd,aes(x=lasso_test_cindex_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all,shape=group))+geom_point()+ggtitle("test cindex versus all aspects")+facet_wrap(~m,ncol=3)+theme_bw()
# #ggsave("lasso_ovarian_checkwith_test_cindexvar2.pdf",gg,height=8,width=10)
# gg=ggplot(dd,aes(x=lasso_test_bs_all,y=lasso_test_distance_all,color=lasso_lambda_all,size=lasso_test_cr_all/100,shape=group))+geom_point(aes(size=lasso_test_cr_all/100))+ggtitle("test bs versus all aspects")+facet_wrap(~m,ncol=3)+theme_bw()
# #ggsave("lasso_ovarian_checkwith_test_bsvar.pdf",gg,height=5,width=10)
# gg=ggplot(dd,aes(x=lasso_test_bs_all,y=lasso_test_distance_all,color=lasso_test_cr_all,shape=group))+geom_point()+ggtitle("test bs versus all aspects")+facet_wrap(~m,ncol=3)+theme_bw()
# #ggsave("lasso_ovarian_checkwith_test_bsvar3.pdf",gg,height=5,width=10)

m1<-wilcox.test( dd[dd$label=="m0.3","lasso_train_cindex_all"],dd[dd$label=="m0.3wr","lasso_train_cindex_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)

m1<-wilcox.test( dd[dd$label=="m0.5","lasso_train_cindex_all"],dd[dd$label=="m0.5wr","lasso_train_cindex_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)

m1<-wilcox.test( dd[dd$label=="m0.7","lasso_train_cindex_all"],dd[dd$label=="m0.7wr","lasso_train_cindex_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)


m1<-wilcox.test( dd[dd$label=="m0.3","lasso_train_bs_all"],dd[dd$label=="m0.3wr","lasso_train_bs_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)

m1<-wilcox.test( dd[dd$label=="m0.5","lasso_train_bs_all"],dd[dd$label=="m0.5wr","lasso_train_bs_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)

m1<-wilcox.test( dd[dd$label=="m0.7","lasso_train_bs_all"],dd[dd$label=="m0.7wr","lasso_train_bs_all"], na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)
print(m1)

#calculate the mean and sd
mean(dd[dd$label=="m0.3","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.3","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.5","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.5","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.7","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.7","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.3wr","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.3wr","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.5wr","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.5wr","lasso_train_cindex_all"])
mean(dd[dd$label=="m0.7wr","lasso_train_cindex_all"])
sd(dd[dd$label=="m0.7wr","lasso_train_cindex_all"])

mean(dd[dd$label=="m0.3","lasso_train_bs_all"])
sd(dd[dd$label=="m0.3","lasso_train_bs_all"])
mean(dd[dd$label=="m0.5","lasso_train_bs_all"])
sd(dd[dd$label=="m0.5","lasso_train_bs_all"])
mean(dd[dd$label=="m0.7","lasso_train_bs_all"])
sd(dd[dd$label=="m0.7","lasso_train_bs_all"])
mean(dd[dd$label=="m0.3wr","lasso_train_bs_all"])
sd(dd[dd$label=="m0.3wr","lasso_train_bs_all"])
mean(dd[dd$label=="m0.5wr","lasso_train_bs_all"])
sd(dd[dd$label=="m0.5wr","lasso_train_bs_all"])
mean(dd[dd$label=="m0.7wr","lasso_train_bs_all"])
sd(dd[dd$label=="m0.7wr","lasso_train_bs_all"])
```

Get comparison with limma
```{r}
#limma selection
#de analysis-- should be on the non-imputed data
current_data33=current_data2
#hist(current_data33$time)
current_data33$os_class=ifelse(current_data33$time<1500&current_data33$status==0,"good","poor")
    #current_data33=current_data33[current_data33$os_class%in% c("good","poor"),]
    expression_current=t(current_data33[,!colnames(current_data33)%in% c("time","status","os_class")])
    groupname<-as.factor(current_data33$os_class)
    design <- model.matrix(~ groupname + 0)
    fit <- lmFit(expression_current, design)
    cont.matrix <- makeContrasts(groupnamegood-groupnamepoor, levels=design)
    fit2 <- contrasts.fit(fit, cont.matrix)
    fit2 <- eBayes(fit2)
    tT <- topTable(fit2)
    df1 <- topTable(fit2, number=nrow(fit2), genelist=rownames(expression_current))
    df1$name=rownames(df1)
    df1$neglogP_value = -log10(df1$P.Value)
    # df1
    # df1[df1$name%in%result_table$name,]
    # df1[df1$name%in%result2_table$name,]
    # dim(df1[df1$adj.P.Val<0.5,])
    
    #generate heatmap for selected variables
#matching the result from boostrapped dataset with the baseline result from limma top 100, notice that the not matched are assigned 0 selection times.
matching_result_with_limma=function(result_table){
wanted_value=result_table$freq[match(df1$name[1:100],result_table$name)]
wanted_value[is.na(wanted_value)]=0
return(wanted_value)
}
#generate the dataset used to plot the heatmap, the rows are the datasets and the columns are those variables
heatmap_data=data.frame(nrow=100*16,ncol=3)
heatmap_data[1:1600,1]=rep(c("limma","m0.2","m0.3","m0.4","m0.5","m0.6","m0.7","m0.8","m0.2wr","m0.3wr","m0.4wr","m0.5wr","m0.6wr","m0.7wr","m0.8wr","m0.9wr"),each=100)
heatmap_data[1:1600,2]=rep(df1$name[1:100],16)
heatmap_data[1:1600,3]=c(df1$neglogP_value[1:100],matching_result_with_limma(result2_table),matching_result_with_limma(result3_table),matching_result_with_limma(result4_table),matching_result_with_limma(result5_table),matching_result_with_limma(result6_table),matching_result_with_limma(result7_table),matching_result_with_limma(result8_table),matching_result_with_limma(result11_table),matching_result_with_limma(result12_table),matching_result_with_limma(result13_table),matching_result_with_limma(result14_table),matching_result_with_limma(result15_table),matching_result_with_limma(result16_table),matching_result_with_limma(result17_table),matching_result_with_limma(result18_table))
colnames(heatmap_data)=c("case","gene","value")

max(heatmap_data$value)
heatmap_data=heatmap_data[heatmap_data$case!="limma",]
ggheatmap <-ggplot(heatmap_data, aes(case, gene, fill= value)) + 
 geom_tile(color = "grey")+scale_fill_gradientn(limits = c(0,max(heatmap_data$value)),colours = c( "#FFFFFF","#FDDBC7", "#EF8A62", "#B2182B"))+ theme(aspect.ratio = 0.5, text = element_text(size = 1), legend.position = "bottom") + labs(y= 'Genes', x = "Cases", fill = 'Selection times')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))
ggheatmap
```

check selected common var prediction performance
```{r}
#comapre the prediction performance using the selected top several variables versus the entire variables under cv
lasso_cv=function(r,data,cvK,variables){
  data2=as.data.frame(data[,which(colnames(data)%in%variables)])
  data2$time=data$time
  data2$status=data$status
  data=data2
  set.seed(r)
  print(r)
  cvSets = cvFolds(nrow(data), cvK)  # permute all the data, into 5 folds
  bicfun=possibly(function(j){
    test_id = cvSets$subsets[cvSets$which == j]
    test = data[test_id, ]
    train = data[-test_id, ]
    tr_matrix=data.matrix(train[,!names(train)%in% c("time","status")])
    te_matrix=data.matrix(test[,!names(test)%in% c("time","status")])
    tr_st=train$time
    tr_y=train$status
    te_st=test$time
    te_y=test$status
    
    fit0=cv.glmnet(tr_matrix, Surv(tr_st,tr_y), family="cox", standardize = F,alpha=1, nfolds = 5,type.measure = "C")
    fit=glmnet(tr_matrix, Surv(tr_st,tr_y), family="cox", standardize = F,alpha=1,lambda = fit0$lambda.min,type.measure = "C")
    #fit=glmnet(tr_matrix, Surv(tr_st,tr_y), family="cox", standardize = F,alpha=1)
    lpnew=predict(fit,newx = te_matrix) #this is the linear predictors (risk?)
    lp<- predict(fit,newx = tr_matrix)
    #cindex
    harrelC1 <- rcorr.cens(-lpnew,Surv(test$time,test$status))
    hc_1<-harrelC1["C Index"]
    Surv.rsp <- Surv(train$time, train$status)
    Surv.rsp.new <- Surv(test$time, test$status) 
    bc_1 <- BeggC(Surv.rsp, Surv.rsp.new,lp, lpnew)
    unoc_1<-UnoC(Surv.rsp, Surv.rsp.new, lpnew)
    ghc_1<-GHCI(lpnew)
    #br
    times=median(test$time)
    br1 <- predErr(Surv.rsp,Surv.rsp.new,lp,lp.new,time=times)$error
    #time-dependent auc
    AUC_CD <- AUC.uno(Surv.rsp, Surv.rsp.new, lpnew, times)$auc
    return(c(hc_1,bc_1,unoc_1,ghc_1,br1,AUC_CD))},otherwise=NA)
  
  cv5_result=rbind.data.frame(bicfun(1),bicfun(2),bicfun(3),bicfun(4),bicfun(5))   
  colnames(cv5_result)=c("hc_1","bc_1","unoc_1","ghc_1","br1","auc")
  return(cv5_result)}

# result_now=colMeans(as.data.frame(lasso_cv(1,current_data2,10,final_selection)))
# result_old=colMeans(as.data.frame(lasso_cv(1,current_data2,10,colnames(current_data2)[1:16048])))
# result_now
# result_old
#bootstrap_var=result_table$name[which(result_table$freq>=1)]
result_now=pbmcapply::pbmclapply(1:20, lasso_cv,current_data2,5, final_selection, mc.cores = 15)
#result_bt=pbmcapply::pbmclapply(1:20, lasso_cv,current_data2,10, bootstrap_var, mc.cores = 15)
result_old=pbmcapply::pbmclapply(1:20, lasso_cv,current_data2,5, colnames(current_data2)[1:(dim(current_data2)[2]-2)], mc.cores = 15)
library(data.table)
colMeans(rbindlist(result_now))
#colMeans(rbindlist(result_bt))
colMeans(rbindlist(result_old))
```

## various sampling techniques
```{r}

#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

load("acc_with.RData")
result_table=get_table(result)[[1]]
#result2_table=get_table(result2)[[1]]
#result3_table=get_table(result3)[[1]]
#result4_table=get_table(result4)[[1]]
result5_table=get_table(result5)[[1]]
result6_table=get_table(result6)[[1]]
result7_table=get_table(result7)[[1]]
# result8_table=get_table(result8)[[1]]
# result9_table=get_table(result9)[[1]]
#result10_table=get_table(result10)[[1]]
result11_table=get_table(result11)[[1]]
result12_table=get_table(result12)[[1]]
result13_table=get_table(result13)[[1]]
#result14_table=get_table(result14)[[1]]
result15_table=get_table(result15)[[1]]
result16_table=get_table(result16)[[1]]
result17_table=get_table(result17)[[1]]

load("acc_gender.RData")
result1new_table=get_table(result1new)[[1]]
result2new_table=get_table(result2new)[[1]]
result3new_table=get_table(result3new)[[1]]
#get average model performances and number of variables selected
# as.numeric(result[[1]][[1]])
# result[[1]][[3]]
# result[[1]][[4]]

other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

heatmap_data=data.frame(nrow=18*13,ncol=18)
heatmap_data[1:(18*13),1]=rep(c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control"),each=18)
heatmap_data[1:(18*13),2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),13)
heatmap_data[1:(18*13),3]=c(other_table(result,current_data2),other_table(result5,current_data2),other_table(result6,current_data2),other_table(result7,current_data2),other_table(result11,current_data2),other_table(result12,current_data2),other_table(result13,current_data2),other_table(result15,current_data2),other_table(result16,current_data2),other_table(result17,current_data2),other_table(result1new,current_data2),other_table(result2new,current_data2),other_table(result3new,current_data2))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))

#generate the dataset used to plot the heatmap, the rows are the datasets and the columns are metrics: censoring rate, cindex, number of variables selected
gg_heatmap_data=heatmap_data
gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]=gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]/max(gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"])
ggheatmap <-ggplot(gg_heatmap_data, aes(case, metric, fill= value)) + 
 geom_tile(color = "grey")+scale_fill_gradientn(limits = c(0,1),colours = c("#2166AC", "#67A9CF" ,"#D1E5F0", "#FFFFFF","#FDDBC7", "#EF8A62", "#B2182B"))+ theme(aspect.ratio = 1, text = element_text(size = 5), legend.position = "bottom") + labs(y= 'Metrics', x = "Cases", fill = 'Values')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))+
  geom_text(aes(label = round(value,3)), color = "black", size = 4)
ggheatmap

#get all seperate scatter plots
plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
ggplot(plotdt_wide2,aes(x=censoring_rate,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with distance_stat")

plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat_test","censoring_rate_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
ggplot(plotdt_wide2,aes(x=censoring_rate_test,y=distance_stat_test,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate test with distance_stat test")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
ggplot(plotdt_wide2,aes(x=num_variables,y=censoring_rate,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
ggplot(plotdt_wide2,aes(x=num_variables,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("distance_stat with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
gg=ggplot(plotdt_wide2,aes(x=num_variables,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with num_variables")+theme_bw()+theme(aspect.ratio = 1)
gg
#ggsave("lasso_lung_with_num_var.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
ggplot(plotdt_wide2,aes(x=cindex_train,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with cindex_train")

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()
gg
ggsave("acc_with_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()
gg
ggsave("acc_with_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
ggsave("acc_with_external.pdf",gg)

#fit model using the entire data on lasso cox and add into the external performance
tr_matrix=data.matrix(current_data2[,!names(current_data2)%in% c("time","status")])
te_matrix=data.matrix(ex_validation[,!names(ex_validation)%in% c("time","status")])
tr_st=current_data2$time
tr_y=current_data2$status
te_st=ex_validation$time
te_y=ex_validation$status
  fit <- fit_lasso(tr_matrix, Surv(tr_st, tr_y), nfolds = 5, rule = "lambda.min")
  tr_times=current_data2$time
  te_times=ex_validation$time
  pred_te_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = te_matrix,pred.at=te_times)
  pred_tr_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = tr_matrix,pred.at=tr_times)
  pred_te=c()
  for(i in 1:nrow(pred_te_matrix)){
    pred_te[i]=pred_te_matrix[i,][which(colnames(pred_te_matrix)==te_times[i])[1]]
  }
  pred_tr=c()
  for(i in 1:nrow(pred_tr_matrix)){
    pred_tr[i]=pred_tr_matrix[i,][which(colnames(pred_tr_matrix)==tr_times[i])[1]]
  }
  harrelC1 <- rcorr.cens(-pred_te,with(ex_validation,Surv(time,status)))
  cindex_test<-harrelC1["C Index"]
  # #calculate brier score:currently cannot be calculated if only have training data
  times=median(current_data2$time)
  Surv.rsp <- Surv(current_data2$time,current_data2$status)
  Surv.rsp.new <- Surv(ex_validation$time,ex_validation$status)
  lp<-pred_tr
  lp.new=pred_te
  bs_test <- predErr(Surv.rsp,Surv.rsp.new,lp,lp.new, time = times)$error
 plotdt_wide2[dim(plotdt_wide2)[1]+1,] =c(round(cindex_test,3),round(bs_test,3),"raw")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
gg
#ggsave("lasso_lung_with_external_raw.pdf",gg)
```


```{r}
#feature selection
#pure intersection: not many
all_variables=list(result_table$name[which(result_table$freq>=1)],result5_table$name[which(result5_table$freq>=1)],result6_table$name[which(result6_table$freq>=1)],result7_table$name[which(result7_table$freq>=1)],result11_table$name[which(result11_table$freq>=1)],result12_table$name[which(result12_table$freq>=1)],result13_table$name[which(result13_table$freq>=1)],result15_table$name[which(result15_table$freq>=1)],result16_table$name[which(result16_table$freq>=1)],result17_table$name[which(result17_table$freq>=1)],result1new_table$name[which(result1new_table$freq>=1)],result2new_table$name[which(result2new_table$freq>=1)],result3new_table$name[which(result3new_table$freq>=1)])

intersection_variables=Reduce(intersect,all_variables)
intersection_variables

#selected time more than 0.75, freq more than 1.
union_vector=unique(c(result_table$name[which(result_table$freq>1)],result5_table$name[which(result5_table$freq>1)],result6_table$name[which(result6_table$freq>1)],result7_table$name[which(result7_table$freq>1)],result11_table$name[which(result11_table$freq>1)],result12_table$name[which(result12_table$freq>1)],result13_table$name[which(result13_table$freq>1)],result15_table$name[which(result15_table$freq>1)],result16_table$name[which(result16_table$freq>1)],result17_table$name[which(result17_table$freq>1)],result1new_table$name[which(result1new_table$freq>1)],result2new_table$name[which(result2new_table$freq>1)],result3new_table$name[which(result3new_table$freq>1)]))


selected_variables=data.frame(matrix(nrow = length(union_vector),ncol = length(all_variables)))
for(i in 1:length(all_variables)){
  for(j in 1:length(union_vector)){
    selected_variables[j,i]=ifelse(union_vector[j]%in%all_variables[[i]],1,0)
  }
}
final_selection=union_vector[which(rowSums(selected_variables)>dim(selected_variables)[2]*(3/4))]
length(final_selection) 
#the number of selected variables are determined by the average of the best performed samples/the bootstrap one
rearranged=union_vector[c(order(rowSums(selected_variables)))]
lasso_variable=final_selection

#add summarise stat
success_rate_fun=function(result){
success_rate=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){success_rate[i]=0}else{success_rate[i]=1}
}
return(sum(success_rate)/length(result))}

lambda_vec_fun=function(result){
lambda_vec=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){lambda_vec[i]=0}else{lambda_vec[i]=result[[i]][[16]]}
}
return(lambda_vec)}

all_train_cindex_fun=function(result){
  all_train_cindex=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cindex[i]=0}else{all_train_cindex[i]=result[[i]][[13]]}
}
return(all_train_cindex)}

all_train_bs_fun=function(result){
  all_train_bs=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_bs[i]=0}else{all_train_bs[i]=result[[i]][[14]]}
}
return(all_train_bs)}

all_train_distance_fun=function(result){
  all_train_distance=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_distance[i]=0}else{all_train_distance[i]=result[[i]][[8]]$statistic}
}
return(all_train_distance)}

all_train_cr_fun=function(result){
  all_train_cr=c()
for(i in 1:length(result)){
  if(length(result[[i]])==1){all_train_cr[i]=0}else{all_train_cr[i]=result[[i]][[1]]}
}
return(all_train_cr)}

#testing
current=heatmap_data[heatmap_data$metric%in%c("cindex","auc","brier_score"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")

lasso_ave=current_wide2$cindex+current_wide2$auc+1-current_wide2$brier_score

dd=cbind.data.frame(rank(-lasso_ave),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3=dd[dd$order%in%c(1,2,3),2]
lasso_cindex=current_wide2$cindex
lasso_auc=current_wide2$auc
lasso_bs=current_wide2$brier_score
lasso_success_rate=c(success_rate_fun(result),success_rate_fun(result5),success_rate_fun(result6),success_rate_fun(result7),success_rate_fun(result11),success_rate_fun(result12),success_rate_fun(result13),success_rate_fun(result15),success_rate_fun(result16),success_rate_fun(result17),success_rate_fun(result1new),success_rate_fun(result2new),success_rate_fun(result3new))

lasso_lambda_all=c(lambda_vec_fun(result),lambda_vec_fun(result5),lambda_vec_fun(result6),lambda_vec_fun(result7),lambda_vec_fun(result11),lambda_vec_fun(result12),lambda_vec_fun(result13),lambda_vec_fun(result15),lambda_vec_fun(result16),lambda_vec_fun(result17),lambda_vec_fun(result1new),lambda_vec_fun(result2new),lambda_vec_fun(result3new))


#external
current=heatmap_data[heatmap_data$metric%in%c("cindex_ex","auc_ex","brier_score_ex"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
lasso_ave_ex=current_wide2$cindex_ex+current_wide2$auc_ex+1-current_wide2$brier_score_ex
lasso_cindex_ex=current_wide2$cindex_ex
lasso_auc_ex=current_wide2$auc_ex
lasso_bs_ex=current_wide2$brier_score_ex

dd=cbind.data.frame(rank(-lasso_ave_ex),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3_ex=dd[dd$order%in%c(1,2,3),2]

#training
current=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train"),]
current_wide=reshape(current,idvar="metric",timevar="case",direction = "wide")
current_wide2=as.data.frame(t(current_wide))
colnames(current_wide2)=current_wide2[1,]
current_wide2=current_wide2[-1,]
current_wide2=apply(current_wide2, 2,as.numeric)
current_wide2=as.data.frame(round(current_wide2,3))
current_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
lasso_ave_train=current_wide2$cindex_train+1-current_wide2$brier_score_train
lasso_cindex_train=current_wide2$cindex_train
lasso_bs_train=current_wide2$brier_score_train

dd=cbind.data.frame(rank(-lasso_ave_train),current_wide2$label)
colnames(dd)=c("order","method")
lasso_top3_train=dd[dd$order%in%c(1,2,3),2]

#lambda with success rate
lasso_lambda_mean=c(mean(lambda_vec_fun(result)),mean(lambda_vec_fun(result5)),mean(lambda_vec_fun(result6)),mean(lambda_vec_fun(result7)),mean(lambda_vec_fun(result11)),mean(lambda_vec_fun(result12)),mean(lambda_vec_fun(result13)),mean(lambda_vec_fun(result15)),mean(lambda_vec_fun(result16)),mean(lambda_vec_fun(result17)),mean(lambda_vec_fun(result1new)),mean(lambda_vec_fun(result2new)),mean(lambda_vec_fun(result3new)))
dd=cbind.data.frame(lasso_success_rate,lasso_lambda_mean,lasso_ave)
dd$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
ggplot(dd,aes(x=lasso_lambda_mean,y=lasso_success_rate,label=label,color=lasso_ave))+geom_point()+geom_text_repel(size=4)+ggtitle("Lambda versus success rate with performance (ave test)")
#train performance with success rate
dd=cbind.data.frame(lasso_success_rate,lasso_lambda_mean,lasso_ave_train)
dd$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control")
ggplot(dd,aes(x=lasso_ave_train,y=lasso_success_rate,label=label,color=lasso_lambda_mean))+geom_point()+geom_text_repel(size=4)+ggtitle("Train performance versus success rate with mean lambda")+theme_bw()
gg=ggplot(dd,aes(x=lasso_ave_train,y=lasso_success_rate,label=label,color=lasso_lambda_mean))+geom_point()+geom_text_repel(size=4)+ggtitle("Train performance versus success rate with mean lambda")+theme_bw()
#ggsave("lasso_lung_with_trainaverage.pdf",gg)
#train performance with vairability within one method
lasso_train_cindex_all=c(all_train_cindex_fun(result),all_train_cindex_fun(result5),all_train_cindex_fun(result6),all_train_cindex_fun(result7),all_train_cindex_fun(result11),all_train_cindex_fun(result12),all_train_cindex_fun(result13),all_train_cindex_fun(result15),all_train_cindex_fun(result16),all_train_cindex_fun(result17),all_train_cindex_fun(result1new),all_train_cindex_fun(result2new),all_train_cindex_fun(result3new))
lasso_train_distance_all=c(all_train_distance_fun(result),all_train_distance_fun(result5),all_train_distance_fun(result6),all_train_distance_fun(result7),all_train_distance_fun(result11),all_train_distance_fun(result12),all_train_distance_fun(result13),all_train_distance_fun(result15),all_train_distance_fun(result16),all_train_distance_fun(result17),all_train_distance_fun(result1new),all_train_distance_fun(result2new),all_train_distance_fun(result3new))
lasso_train_cr_all=c(all_train_cr_fun(result),all_train_cr_fun(result5),all_train_cr_fun(result6),all_train_cr_fun(result7),all_train_cr_fun(result11),all_train_cr_fun(result12),all_train_cr_fun(result13),all_train_cr_fun(result15),all_train_cr_fun(result16),all_train_cr_fun(result17),all_train_cr_fun(result1new),all_train_cr_fun(result2new),all_train_cr_fun(result3new))
lasso_train_bs_all=c(all_train_bs_fun(result),all_train_bs_fun(result5),all_train_bs_fun(result6),all_train_bs_fun(result7),all_train_bs_fun(result11),all_train_bs_fun(result12),all_train_bs_fun(result13),all_train_bs_fun(result15),all_train_bs_fun(result16),all_train_bs_fun(result17),all_train_bs_fun(result1new),all_train_bs_fun(result2new),all_train_bs_fun(result3new))
```

```{r eval=FALSE}
stability_selection_variables=list(result_table$name[which(result_table$freq>=lasso_success_rate[1]*100*0.6)],result2_table$name[which(result2_table$freq>=lasso_success_rate[2]*100*0.6)],result3_table$name[which(result3_table$freq>=lasso_success_rate[3]*100*0.6)],result4_table$name[which(result4_table$freq>=lasso_success_rate[4]*100*0.6)],result5_table$name[which(result5_table$freq>=lasso_success_rate[5]*100*0.6)],result6_table$name[which(result6_table$freq>=lasso_success_rate[6]*100*0.6)],result7_table$name[which(result7_table$freq>=lasso_success_rate[7]*100*0.6)],result8_table$name[which(result8_table$freq>=lasso_success_rate[8]*100*0.6)],result9_table$name[which(result9_table$freq>=lasso_success_rate[9]*100*0.6)],result10_table$name[which(result10_table$freq>=lasso_success_rate[10]*100*0.6)],result11_table$name[which(result11_table$freq>=lasso_success_rate[11]*100*0.6)],result12_table$name[which(result12_table$freq>=lasso_success_rate[12]*100*0.6)],result13_table$name[which(result13_table$freq>=lasso_success_rate[13]*100*0.6)],result14_table$name[which(result14_table$freq>=lasso_success_rate[14]*100*0.6)],result15_table$name[which(result15_table$freq>=lasso_success_rate[15]*100*0.6)],result16_table$name[which(result16_table$freq>=lasso_success_rate[16]*100*0.6)],result17_table$name[which(result17_table$freq>=lasso_success_rate[17]*100*0.6)])
#stability_selection_variables
fdr_fun=function(variable_names){
  tp=sum(variable_names%in%c("x.X1","x.X2","x.X3","x.X4" ,"x.X5","x.X6"))
  fp=length(variable_names)-tp
  fdr=fp/(fp+tp)
  return(fdr)
}
stability_selection_fdr=c()
for(i in 1:length(stability_selection_variables)){
  stability_selection_fdr[i]=fdr_fun(unlist(stability_selection_variables[[i]]))
}
stability_selection_fdr
```

```{r fig.height=30,fig.width=30}
dd=cbind.data.frame(lasso_train_cindex_all,lasso_train_distance_all,lasso_lambda_all,lasso_train_cr_all,lasso_train_bs_all)
dd$label=rep(c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control"),each=500)
# g1=ggplot(dd[1:100,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("bootstrap")
# g2=ggplot(dd[101:200,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.1")
# g3=ggplot(dd[201:300,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.2")
# g4=ggplot(dd[301:400,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.3")
# g5=ggplot(dd[401:500,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.4")
# g6=ggplot(dd[501:600,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.5")
# g7=ggplot(dd[601:700,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.6")
# g8=ggplot(dd[701:800,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.7")
# g9=ggplot(dd[801:900,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.8")
# g10=ggplot(dd[901:1000,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.1")
# g11=ggplot(dd[1001:1100,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.3")
# g12=ggplot(dd[1101:1200,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.5")
# g13=ggplot(dd[1201:1300,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.7")
# g14=ggplot(dd[1301:1400,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.1wr")
# g15=ggplot(dd[1401:1500,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.3wr")
# g16=ggplot(dd[1501:1600,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.5wr")
# g17=ggplot(dd[1601:1700,],aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.7wr")
# ggarrange(g1,g2,g3,g4,g5,g6,g7,g8,g9,g10,g11,g12,g13,g14,g15,g16,g17,nrow=5,ncol=4)
# 
# g1=ggplot(dd[1:100,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("bootstrap")
# g2=ggplot(dd[101:200,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.1")
# g3=ggplot(dd[201:300,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.2")
# g4=ggplot(dd[301:400,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.3")
# g5=ggplot(dd[401:500,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.4")
# g6=ggplot(dd[501:600,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.5")
# g7=ggplot(dd[601:700,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.6")
# g8=ggplot(dd[701:800,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.7")
# g9=ggplot(dd[801:900,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("c0.8")
# g10=ggplot(dd[901:1000,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.1")
# g11=ggplot(dd[1001:1100,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.3")
# g12=ggplot(dd[1101:1200,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.5")
# g13=ggplot(dd[1201:1300,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.7")
# g14=ggplot(dd[1301:1400,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.1wr")
# g15=ggplot(dd[1401:1500,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.3wr")
# g16=ggplot(dd[1501:1600,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.5wr")
# g17=ggplot(dd[1601:1700,],aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("m0.7wr")
# ggarrange(g1,g2,g3,g4,g5,g6,g7,g8,g9,g10,g11,g12,g13,g14,g15,g16,g17,nrow=5,ncol=4)

```

```{r fig.height=30,fig.width=30}
dd$label=factor(rep(c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control"),each=500),levels=c("bootstrap","c0.4","c0.5","c0.6","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr","0.2control","0.5control","0.7control"))
dim(dd)
dd=dd[-which(dd$lasso_train_cindex_all==0),]
dim(dd)
# dd=dd[-which(dd$label%in%c("c0.1","c0.8","m0.1","m0.1wr")),]
# dim(dd)
ggplot(dd,aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("train cindex versus all aspects")+facet_wrap(~label,ncol=5)+theme_bw()
ggplot(dd,aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("train bs versus all aspects")+facet_wrap(~label,ncol=5)+theme_bw()
gg=ggplot(dd,aes(x=lasso_train_cindex_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("train cindex versus all aspects")+facet_wrap(~label,ncol=5)+theme_bw()
#ggsave("lasso_lung_with_train_cindexvar.pdf",gg,height=10,width=20)
gg=ggplot(dd,aes(x=lasso_train_bs_all,y=lasso_train_distance_all,color=lasso_lambda_all,size=lasso_train_cr_all))+geom_point()+ggtitle("train bs versus all aspects")+facet_wrap(~label,ncol=5)+theme_bw()
#ggsave("lasso_lung_with_train_bsvar.pdf",gg,height=10,width=20)
```



## as a case study: various sampling techniques
```{r}

#get results table
get_table=function(result){
var=colnames(current_data2)[!colnames(current_data2)%in% c("time","status")]
summary_coef=data.frame(matrix(nrow=length(var),ncol=1))
rownames(summary_coef)=var
coeff_all=c()
for(i in 1:length(result)){
  if(length(result[[i]])>1){
  coeff_all=c(coeff_all,result[[i]][[2]])}else{coeff_all=c(coeff_all)}
}
coeff_all1=as.data.frame(table(coeff_all))
colnames(coeff_all1)=c("name","freq")
for(i in 1:length(var)){
    summary_coef[i,1]=ifelse(var[i] %in% coeff_all1$name,coeff_all1[coeff_all1$name==var[i],"freq"],0)
}
return(list(coeff_all1,summary_coef))}

load("acc_with.RData")
result_table=get_table(result)[[1]]
#result2_table=get_table(result2)[[1]]
#result3_table=get_table(result3)[[1]]
#result4_table=get_table(result4)[[1]]
result5_table=get_table(result5)[[1]]
result6_table=get_table(result6)[[1]]
result7_table=get_table(result7)[[1]]
# result8_table=get_table(result8)[[1]]
# result9_table=get_table(result9)[[1]]
#result10_table=get_table(result10)[[1]]
result11_table=get_table(result11)[[1]]
result12_table=get_table(result12)[[1]]
result13_table=get_table(result13)[[1]]
#result14_table=get_table(result14)[[1]]
result15_table=get_table(result15)[[1]]
result16_table=get_table(result16)[[1]]
result17_table=get_table(result17)[[1]]

load("acc_gender.RData")
result1new_table=get_table(result1new)[[1]]
result2new_table=get_table(result2new)[[1]]
result3new_table=get_table(result3new)[[1]]
#get average model performances and number of variables selected
# as.numeric(result[[1]][[1]])
# result[[1]][[3]]
# result[[1]][[4]]
load("acc_without.RData")#0.3,0.5,0.7
result2=result11
result3=result12
result4=result13
result8=result15
result9=result16
result10=result17

result2_table=get_table(result2)[[1]]
result3_table=get_table(result3)[[1]]
result4_table=get_table(result4)[[1]]
result8_table=get_table(result8)[[1]]
result9_table=get_table(result9)[[1]]
result10_table=get_table(result10)[[1]]






other_table=function(result,data){
  censoring_rate=c()
  cindex=c()
  num_variables=c()
  brier_score=c()
  auc=c()
  distance_stat=c()
  distance_p=c()
  
  censoring_rate_test=c()
  distance_stat_test=c()
  distance_p_test=c()
  
  lambda=c()
  npasses=c()
  devratio=c()
  
  cindex_train=c()
  brier_score_train=c()
  
  cindex_ex=c()
  brier_score_ex=c()
  auc_ex=c()
  
  # auc_all_test=list()
  # auc_all_ex=list()
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    censoring_rate[i]=result[[i]][[1]]
    cindex[i]=result[[i]][[3]]
    num_variables[i]=result[[i]][[4]]/dim(data)[2]
    brier_score[i]=result[[i]][[5]]
    auc[i]=result[[i]][[6]]
    distance_stat[i]=result[[i]][[8]]$statistic
    distance_p[i]=result[[i]][[8]]$p.value
    
    censoring_rate_test[i]=result[[i]][[7]]
    distance_stat_test[i]=result[[i]][[9]]$statistic
    distance_p_test[i]=result[[i]][[9]]$p.value
    lambda[i]=result[[i]][[10]]
    npasses[i]=result[[i]][[11]]
    devratio[i]=result[[i]][[12]]
    
    cindex_train[i]=result[[i]][[13]]
    brier_score_train[i]=result[[i]][[14]]
    
    cindex_ex[i]=result[[i]][[15]]
    brier_score_ex[i]=result[[i]][[16]]
    auc_ex[i]=result[[i]][[17]]
    
    # auc_all_test[[i]]=result[[i]][[18]]
    # auc_all_ex[[i]]=result[[i]][[19]]
    
    }else{
    censoring_rate[i]=NA
    cindex[i]=NA
    num_variables[i]=NA
    brier_score[i]=NA
    auc[i]=NA
    distance_stat[i]=NA
    distance_p[i]=NA
    censoring_rate_test[i]=NA
  distance_stat_test[i]=NA
  distance_p_test[i]=NA
  lambda[i]=NA
  npasses[i]=NA
  devratio[i]=NA
  cindex_train[i]=NA
  brier_score_train[i]=NA
  cindex_ex[i]=NA
  brier_score_ex[i]=NA
  auc_ex[i]=NA
  
  # auc_all_test[[i]]=NA
  # auc_all_ex[[i]]=NA
  }}
  return(c(mean(censoring_rate,na.rm=TRUE),mean(num_variables,na.rm=TRUE),mean(cindex,na.rm=TRUE),mean(auc,na.rm=TRUE),mean(brier_score,na.rm=TRUE),mean(distance_stat,na.rm=TRUE),mean(distance_p,na.rm=TRUE),mean(censoring_rate_test,na.rm=TRUE),mean(distance_stat_test,na.rm=TRUE),mean(distance_p_test,na.rm=TRUE),mean(lambda,na.rm=TRUE),mean(npasses,na.rm=TRUE),mean(devratio,na.rm=TRUE),mean(cindex_train,na.rm=TRUE),mean(brier_score_train,na.rm=TRUE),mean(cindex_ex,na.rm=TRUE),mean(brier_score_ex,na.rm=TRUE),mean(auc_ex,na.rm=TRUE)))
}

heatmap_data=data.frame(nrow=18*19,ncol=18)
heatmap_data[1:(18*19),1]=rep(c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr"),each=18)
heatmap_data[1:(18*19),2]=rep(c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"),19)
heatmap_data[1:(18*19),3]=c(other_table(result,current_data2),other_table(result5,current_data2),other_table(result6,current_data2),other_table(result7,current_data2),other_table(result11,current_data2),other_table(result12,current_data2),other_table(result13,current_data2),other_table(result15,current_data2),other_table(result16,current_data2),other_table(result17,current_data2),other_table(result1new,current_data2),other_table(result2new,current_data2),other_table(result3new,current_data2),other_table(result2,current_data2),other_table(result3,current_data2),other_table(result4,current_data2),other_table(result8,current_data2),other_table(result9,current_data2),other_table(result10,current_data2))
colnames(heatmap_data)=c("case","metric","value")
heatmap_data$metric=factor(heatmap_data$metric,levels = c("censoring_rate","num_variables","cindex","auc","brier_score","distance_stat","distance_p","censoring_rate_test","distance_stat_test","distance_p_test","lambda","npasses","devratio","cindex_train","brier_score_train","cindex_ex","brier_score_ex","auc_ex"))

#generate the dataset used to plot the heatmap, the rows are the datasets and the columns are metrics: censoring rate, cindex, number of variables selected
gg_heatmap_data=heatmap_data
gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]=gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"]/max(gg_heatmap_data[gg_heatmap_data$metric=="brier_score","value"])
ggheatmap <-ggplot(gg_heatmap_data, aes(case, metric, fill= value)) + 
 geom_tile(color = "grey")+scale_fill_gradientn(limits = c(0,1),colours = c("#2166AC", "#67A9CF" ,"#D1E5F0", "#FFFFFF","#FDDBC7", "#EF8A62", "#B2182B"))+ theme(aspect.ratio = 1, text = element_text(size = 5), legend.position = "bottom") + labs(y= 'Metrics', x = "Cases", fill = 'Values')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))+
  geom_text(aes(label = round(value,3)), color = "black", size = 4)
ggheatmap

#get all seperate scatter plots
plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with distance_stat")

plotdt=heatmap_data[heatmap_data$metric%in%c("distance_stat_test","censoring_rate_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=censoring_rate_test,y=distance_stat_test,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate test with distance_stat test")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","censoring_rate"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=censoring_rate,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Censoring rate with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=num_variables,y=distance_stat,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("distance_stat with num_variables")

plotdt=heatmap_data[heatmap_data$metric%in%c("num_variables","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=num_variables,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with num_variables")+theme_bw()+theme(aspect.ratio = 1)
gg
#ggsave("lasso_lung_with_num_var.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","lambda"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")
ggplot(plotdt_wide2,aes(x=cindex_train,y=lambda,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("lambda with cindex_train")

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_train","brier_score_train","censoring_rate","distance_stat"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_train,y=cindex_train,label=label,color=censoring_rate,size=distance_stat))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in train")+theme_bw()+theme(aspect.ratio = 1)
gg
ggsave("accfull_with_train.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex","brier_score","censoring_rate_test","distance_stat_test"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score,y=cindex,label=label,color=censoring_rate_test,size=distance_stat_test))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in test")+theme_bw()+theme(aspect.ratio = 1)
gg
ggsave("accfull_with_test.pdf",gg)

plotdt=heatmap_data[heatmap_data$metric%in%c("cindex_ex","brier_score_ex"),]
plotdt_wide=reshape(plotdt,idvar="metric",timevar="case",direction = "wide")
plotdt_wide2=as.data.frame(t(plotdt_wide))
colnames(plotdt_wide2)=plotdt_wide2[1,]
plotdt_wide2=plotdt_wide2[-1,]
plotdt_wide2=apply(plotdt_wide2, 2,as.numeric)
plotdt_wide2=as.data.frame(round(plotdt_wide2,3))
plotdt_wide2$label=c("bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr")
gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()+theme(aspect.ratio = 1)
gg
ggsave("accfull_with_external.pdf",gg)

# #fit model using the entire data on lasso cox and add into the external performance
# tr_matrix=data.matrix(current_data2[,!names(current_data2)%in% c("time","status")])
# te_matrix=data.matrix(ex_validation[,!names(ex_validation)%in% c("time","status")])
# tr_st=current_data2$time
# tr_y=current_data2$status
# te_st=ex_validation$time
# te_y=ex_validation$status
#   fit <- fit_lasso(tr_matrix, Surv(tr_st, tr_y), nfolds = 5, rule = "lambda.min")
#   tr_times=current_data2$time
#   te_times=ex_validation$time
#   pred_te_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = te_matrix,pred.at=te_times)
#   pred_tr_matrix=predict(fit,tr_matrix, Surv(tr_st, tr_y), newx = tr_matrix,pred.at=tr_times)
#   pred_te=c()
#   for(i in 1:nrow(pred_te_matrix)){
#     pred_te[i]=pred_te_matrix[i,][which(colnames(pred_te_matrix)==te_times[i])[1]]
#   }
#   pred_tr=c()
#   for(i in 1:nrow(pred_tr_matrix)){
#     pred_tr[i]=pred_tr_matrix[i,][which(colnames(pred_tr_matrix)==tr_times[i])[1]]
#   }
#   harrelC1 <- rcorr.cens(-pred_te,with(ex_validation,Surv(time,status)))
#   cindex_test<-harrelC1["C Index"]
#   # #calculate brier score:currently cannot be calculated if only have training data
#   times=median(current_data2$time)
#   Surv.rsp <- Surv(current_data2$time,current_data2$status)
#   Surv.rsp.new <- Surv(ex_validation$time,ex_validation$status)
#   lp<-pred_tr
#   lp.new=pred_te
#   bs_test <- predErr(Surv.rsp,Surv.rsp.new,lp,lp.new, time = times)$error
#  plotdt_wide2[dim(plotdt_wide2)[1]+1,] =c(round(cindex_test,3),round(bs_test,3),"raw")
# gg=ggplot(plotdt_wide2,aes(x=brier_score_ex,y=cindex_ex,label=label))+geom_point()+geom_text_repel(size=4)+ggtitle("Prediction performances in external data")+theme_bw()
# gg
#ggsave("lasso_lung_with_external_raw.pdf",gg)
```

with limma comparison of features
```{r}
#generate the dataset used to plot the heatmap, the rows are the datasets and the columns are those variables
heatmap_data=data.frame(nrow=100*20,ncol=3)
heatmap_data[1:2000,1]=rep(c("limma","bootstrap","c0.4","c0.5","c0.6","m0.3wc","m0.5wc","m0.7wc","m0.3wrwc","m0.5wrwc","m0.7wrwc","0.2control","0.5control","0.7control","m0.3","m0.5","m0.7","m0.3wr","m0.5wr","m0.7wr"),each=100)
heatmap_data[1:2000,2]=rep(df1$name[1:100],20)
heatmap_data[1:2000,3]=c(df1$neglogP_value[1:100],matching_result_with_limma(result_table),matching_result_with_limma(result5_table),matching_result_with_limma(result6_table),matching_result_with_limma(result7_table),matching_result_with_limma(result11_table),matching_result_with_limma(result12_table),matching_result_with_limma(result13_table),matching_result_with_limma(result15_table),matching_result_with_limma(result16_table),matching_result_with_limma(result17_table),matching_result_with_limma(result1new_table),matching_result_with_limma(result2new_table),matching_result_with_limma(result3new_table),matching_result_with_limma(result2_table),matching_result_with_limma(result3_table),matching_result_with_limma(result4_table),matching_result_with_limma(result8_table),matching_result_with_limma(result9_table),matching_result_with_limma(result10_table))
colnames(heatmap_data)=c("case","gene","value")

max(heatmap_data$value)
heatmap_data=heatmap_data[heatmap_data$case!="limma",]
ggheatmap <-ggplot(heatmap_data, aes(case, gene, fill= value)) + 
 geom_tile(color = "grey")+scale_fill_gradientn(limits = c(0,max(heatmap_data$value)),colours = c( "#FFFFFF","#FDDBC7", "#EF8A62", "#B2182B"))+ theme(aspect.ratio = 1, text = element_text(size = 1), legend.position = "bottom") + labs(y= 'Genes', x = "Cases", fill = 'Selection times')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))
ggheatmap
#update this heatmap to be prettier
heatmap_data=heatmap_data[heatmap_data$case!="limma",]
discreate_col=factor(ifelse(heatmap_data$value<2,"white",ifelse(heatmap_data$value>=2&heatmap_data$value<50,"light_orange",ifelse(heatmap_data$value>=50&heatmap_data$value<100,"orange","red"))),levels = c("white","light_orange","orange","red"))
heatmap_data$discreate_col=discreate_col
cols <- c("white" = "#FFFFFF", "light_orange" = "#FDDBC7", "orange" = "#EF8A62", "red" = "#B2182B")
ggheatmap <-ggplot(heatmap_data, aes(case, gene, fill= discreate_col)) + 
 geom_tile(color = "grey")+scale_fill_manual(values = cols)+ theme(aspect.ratio = 1, text = element_text(size = 1), legend.position = "bottom") + labs(y= 'Genes', x = "Cases", fill = 'Selection times')+theme_bw()+theme(axis.text.x = element_text(color = "black", size = 5),axis.text.y = element_text(color = "black", size = 6))
ggheatmap
```

with calibration plot
```{r}
# plot_list1=list()
# plot_list2=list()
# plot_list3=list()
# result_list=list(result,result5,result6,result7,result11,result12,result13,result15,result16,result17,result1new,result2new,result3new,result2,result3,result4,result8,result9,result10)
# example_result=list()
# i=1
# for(j in 1:length(result_list)){
#   while(length(result_list[[j]][[i]])<2){
#     i=i+1
#   if(length(result_list[[j]][[i]])>2){
#     print(i)
#   }}
#   example_result[[j]]=current_result
# }
# 
# 
# plot_list1=list()
# plot_list2=list()
# plot_list3=list()   
# for(j in 1:length(result_list)){
#   if(length(result_list[[j]][[80]])>2){
#     print("yes")
#     p1=plot(result_list[[j]][[80]][[20]])
#     p2=plot(result_list[[j]][[80]][[21]])
#     p3=plot(result_list[[j]][[80]][[22]])
#     plot_list1[[j]]=p1
#     plot_list2[[j]]=p2
#     plot_list3[[j]]=p3
#   }else{
#     plot_list1[[j]]=NA
#     plot_list2[[j]]=NA
#     plot_list3[[j]]=NA
#   }}
# 
# sum(is.na(plot_list1))
# sum(is.na(plot_list2))
# sum(is.na(plot_list3))


result_list=list(result,result5,result6,result7,result11,result12,result13,result15,result16,result17,result1new,result2new,result3new,result2,result3,result4,result8,result9,result10)    
#bootstrap
g1=plot(result[[7]][[20]])
g2=plot(result[[7]][[21]])
g3=plot(result[[7]][[22]])
#c0.5
g4=plot(result6[[1]][[20]])
g5=plot(result6[[1]][[21]])
g6=plot(result6[[1]][[22]])
#m0.5wc
for(i in 1:500){
  if(length(result12[[i]])>2){
    print(i)
  }
}
g7=plot(result12[[38]][[20]])
g8=plot(result12[[38]][[21]])
g9=plot(result12[[38]][[22]])
#control0.5
g10=plot(result2new[[1]][[20]])
g11=plot(result2new[[1]][[21]])
g12=plot(result2new[[1]][[22]])

gg=ggarrange(g1,g2,g3,g4,g5,g6,g7,g8,g9,g10,g11,g12,nrow=4,ncol=3)
ggsave("accfull_calibration.pdf",gg,height = 20,width = 20)
```

with time-dependent AUC plot
```{r}
auc_table=function(result){
  auc_all_test=matrix(NA,ncol=10,nrow=length(result))
  auc_all_ex=matrix(NA,ncol=10,nrow=length(result))
  for(i in 1:length(result)){
    if(length(result[[i]])>1){
    auc_all_test[i,1:10]=result[[i]][[18]]
    auc_all_ex[i,1:10]=result[[i]][[19]]
    }else{
  auc_all_test[i,1:10]=rep(NA,10)
  auc_all_ex[i,1:10]=rep(NA,10)
    }
  }
  return(list(colMeans(auc_all_test,na.rm = TRUE),colMeans(auc_all_ex,na.rm = TRUE)))
}

plotdt=rbind.data.frame(auc_table(result)[[1]],auc_table(result6)[[1]],auc_table(result12)[[1]],auc_table(result2new)[[1]])
colnames(plotdt)=c(1:10)
plotdt$method=c("bootstrp","c0.5","m0.5wc","control0.5")
long=melt(plotdt, id.vars = c("method"), variable.name = "timepoint")
long$method=factor(long$method,levels=c("bootstrp","c0.5","m0.5wc","control0.5"))
library(RColorBrewer)
mycolors <- brewer.pal(4,"Set2")
names(mycolors)=levels(long$method)
library(scales)
gg1=ggplot(long,aes(x=as.integer(timepoint),y=value,color=method))+geom_line(aes(color=method))+scale_color_manual(values = mycolors, drop=FALSE)+theme_bw() + scale_x_continuous(breaks= pretty_breaks())
gg1
#ggsave("accfull_auc_test.pdf",gg)

plotdt=rbind.data.frame(auc_table(result)[[2]],auc_table(result6)[[2]],auc_table(result12)[[2]],auc_table(result2new)[[2]])
colnames(plotdt)=c(1:10)
plotdt$method=c("bootstrp","c0.5","m0.5wc","control0.5")
long=melt(plotdt, id.vars = c("method"), variable.name = "timepoint")
long$method=factor(long$method,levels=c("bootstrp","c0.5","m0.5wc","control0.5"))
mycolors <- brewer.pal(4,"Set2")
names(mycolors)=levels(long$method)
gg2=ggplot(long,aes(x=as.integer(timepoint),y=value,color=method))+geom_line(aes(color=method))+scale_color_manual(values = mycolors, drop=FALSE)+theme_bw()+ scale_x_continuous(breaks= pretty_breaks())
gg2

ggarrange(gg1,gg2,nrow=1)
ggsave("accfull_auc.pdf",ggarrange(gg1,gg2,nrow=1),width = 10,height = 5)
```





